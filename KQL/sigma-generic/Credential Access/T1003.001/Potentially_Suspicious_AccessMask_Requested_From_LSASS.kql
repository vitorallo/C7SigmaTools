// Title: Potentially Suspicious AccessMask Requested From LSASS
// Author: Roberto Rodriguez, Teymur Kheirkhabarov, Dimitrios Slamaris, Mark Russinovich, Aleksey Potapov, oscd.community (update)
// Date: 2019-11-01
// Level: medium
// Description: Detects process handle on LSASS process with certain access maskThe SecurityEvent table in Microsoft Sentinel contains security-related events from Windows machines. To have this table present, ensure that you have the Microsoft Sentinel agent installed on the Windows machines and that they are sending security event logs to your Sentinel workspace.
// Tags: attack.credential-access, car.2019-04-004, attack.t1003.001
// ================================================================== 

SecurityEvent
| where (((AccessMask contains "0x40" or AccessMask contains "0x1400" or AccessMask contains "0x100000" or AccessMask contains "0x1410" or AccessMask contains "0x1010" or AccessMask contains "0x1438" or AccessMask contains "0x143a" or AccessMask contains "0x1418" or AccessMask contains "0x1f0fff" or AccessMask contains "0x1f1fff" or AccessMask contains "0x1f2fff" or AccessMask contains "0x1f3fff") and RegistryKey endswith "\\lsass.exe") or ((AccessList contains "4484" or AccessList contains "4416") and RegistryKey endswith "\\lsass.exe")) and (not(((AccessList contains "%%4484" and InitiatingProcessFolderPath contains ":\\Windows\\Temp\\asgard2-agent-sc\\aurora\\" and InitiatingProcessFolderPath endswith "\\aurora-agent-64.exe") or (AccessList contains "%%4484" and (InitiatingProcessFolderPath contains ":\\Users\\" and InitiatingProcessFolderPath contains "\\AppData\\Local\\Temp\\is-") and InitiatingProcessFolderPath endswith "\\avira_system_speedup.tmp") or (AccessList contains "%%4484" and InitiatingProcessFolderPath contains ":\\Windows\\Temp\\" and InitiatingProcessFolderPath endswith "\\avira_speedup_setup_update.tmp") or (InitiatingProcessFolderPath endswith ":\\Windows\\System32\\taskhostw.exe" or InitiatingProcessFolderPath endswith ":\\Windows\\System32\\msiexec.exe" or InitiatingProcessFolderPath endswith ":\\Windows\\CCM\\CcmExec.exe") or InitiatingProcessFolderPath contains ":\\Program Files" or (AccessList contains "%%4484" and InitiatingProcessFolderPath contains ":\\Windows\\SystemTemp\\" and InitiatingProcessFolderPath endswith "\\GoogleUpdate.exe") or (AccessList contains "%%4484" and InitiatingProcessFolderPath endswith "\\x64\\SCENARIOENGINE.EXE") or (AccessList contains "%%4484" and InitiatingProcessFolderPath endswith ":\\Windows\\System32\\snmp.exe") or ((InitiatingProcessFolderPath contains ":\\Program Files (x86)\\" or InitiatingProcessFolderPath contains ":\\Program Files\\" or InitiatingProcessFolderPath contains ":\\ProgramData\\Microsoft\\Windows Defender\\Platform\\" or InitiatingProcessFolderPath contains ":\\Windows\\SysNative\\" or InitiatingProcessFolderPath contains ":\\Windows\\System32\\" or InitiatingProcessFolderPath contains ":\\Windows\\SysWow64\\" or InitiatingProcessFolderPath contains ":\\Windows\\Temp\\asgard2-agent\\") and (InitiatingProcessFolderPath endswith "\\csrss.exe" or InitiatingProcessFolderPath endswith "\\GamingServices.exe" or InitiatingProcessFolderPath endswith "\\lsm.exe" or InitiatingProcessFolderPath endswith "\\MicrosoftEdgeUpdate.exe" or InitiatingProcessFolderPath endswith "\\minionhost.exe" or InitiatingProcessFolderPath endswith "\\MRT.exe" or InitiatingProcessFolderPath endswith "\\MsMpEng.exe" or InitiatingProcessFolderPath endswith "\\perfmon.exe" or InitiatingProcessFolderPath endswith "\\procexp.exe" or InitiatingProcessFolderPath endswith "\\procexp64.exe" or InitiatingProcessFolderPath endswith "\\svchost.exe" or InitiatingProcessFolderPath endswith "\\taskmgr.exe" or InitiatingProcessFolderPath endswith "\\thor.exe" or InitiatingProcessFolderPath endswith "\\thor64.exe" or InitiatingProcessFolderPath endswith "\\vmtoolsd.exe" or InitiatingProcessFolderPath endswith "\\VsTskMgr.exe" or InitiatingProcessFolderPath endswith "\\wininit.exe" or InitiatingProcessFolderPath endswith "\\wmiprvse.exe" or InitiatingProcessFolderPath endswith "RtkAudUService64")) or (AccessList contains "%%4484" and InitiatingProcessFolderPath endswith ":\\Windows\\Sysmon64.exe")))) and (not((AccessList contains "%%4484" and (InitiatingProcessFolderPath endswith "\\procmon64.exe" or InitiatingProcessFolderPath endswith "\\procmon.exe"))))
// Title: Remote Thread Creation By Uncommon Source Image
// Author: Perez Diego (@darkquassar), oscd.community
// Date: 2019-10-27
// Level: medium
// Description: Detects uncommon processes creating remote threads.The SecurityEvent table in Microsoft Sentinel contains Windows security events, including events related to creating remote threads. Ensure that the Windows Security events data connector is enabled in Sentinel to have access to this table.
// Tags: attack.privilege-escalation, attack.defense-evasion, attack.t1055
// ================================================================== 

SecurityEvent
| where (InitiatingProcessFolderPath endswith "\\explorer.exe" or InitiatingProcessFolderPath endswith "\\iexplore.exe" or InitiatingProcessFolderPath endswith "\\msiexec.exe" or InitiatingProcessFolderPath endswith "\\powerpnt.exe" or InitiatingProcessFolderPath endswith "\\schtasks.exe" or InitiatingProcessFolderPath endswith "\\winlogon.exe") and (not((TargetImage =~ "" or (InitiatingProcessFolderPath =~ "C:\\Windows\\explorer.exe" and (TargetImage startswith "C:\\Program Files (x86)\\" or TargetImage startswith "C:\\Program Files\\" or TargetImage startswith "C:\\Windows\\System32\\" or TargetImage startswith "C:\\Windows\\SysWOW64\\")) or (InitiatingProcessFolderPath endswith "\\msiexec.exe" and (TargetImage contains "\\AppData\\Local\\" or TargetImage contains "C:\\Program Files (x86)\\" or TargetImage contains "C:\\Program Files\\")) or isnull(TargetImage) or ((InitiatingProcessFolderPath in~ ("C:\\Windows\\System32\\schtasks.exe", "C:\\Windows\\SysWOW64\\schtasks.exe")) and TargetImage =~ "C:\\Windows\\System32\\conhost.exe") or TargetImage =~ "System" or (InitiatingProcessFolderPath =~ "C:\\Windows\\System32\\winlogon.exe" and (TargetImage in~ ("C:\\Windows\\System32\\services.exe", "C:\\Windows\\System32\\wininit.exe", "C:\\Windows\\System32\\csrss.exe", "C:\\Windows\\System32\\LogonUI.exe"))) or (InitiatingProcessFolderPath =~ "C:\\Windows\\System32\\winlogon.exe" and TargetParentProcessId == 4)))) and (not((((SourceCommandLine contains "https://" and SourceCommandLine contains ".checkpoint.com/documents/" and SourceCommandLine contains "SmartConsole_OLH/" and SourceCommandLine contains "default.htm#cshid=") and InitiatingProcessFolderPath =~ "C:\\Program Files\\internet explorer\\iexplore.exe") or (InitiatingProcessFolderPath =~ "C:\\Program Files\\internet explorer\\iexplore.exe" and (SourceParentImage contains "\\CheckPoint\\SmartConsole\\" and SourceParentImage contains "\\SmartConsole.exe") and (SourceParentImage startswith "C:\\Program Files\\" or SourceParentImage startswith "C:\\Program Files (x86)\\")) or (InitiatingProcessFolderPath contains "\\Microsoft Office\\" and InitiatingProcessFolderPath endswith "\\POWERPNT.EXE" and TargetImage =~ "C:\\Windows\\System32\\csrss.exe"))))
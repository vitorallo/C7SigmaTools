// Title: Rare Remote Thread Creation By Uncommon Source Image
// Author: Perez Diego (@darkquassar), oscd.community
// Date: 2019-10-27
// Level: high
// Description: Detects uncommon processes creating remote threads.The SecurityEvent table in Microsoft Sentinel contains Windows security events, which can include events related to creating remote threads. Ensure that the Windows Security events data connector is enabled in Microsoft Sentinel to have access to this table.
// Tags: attack.privilege-escalation, attack.defense-evasion, attack.t1055
// ================================================================== 

SecurityEvent
| where InitiatingProcessFolderPath endswith "\\bash.exe" or InitiatingProcessFolderPath endswith "\\cscript.exe" or InitiatingProcessFolderPath endswith "\\cvtres.exe" or InitiatingProcessFolderPath endswith "\\defrag.exe" or InitiatingProcessFolderPath endswith "\\dialer.exe" or InitiatingProcessFolderPath endswith "\\dnx.exe" or InitiatingProcessFolderPath endswith "\\esentutl.exe" or InitiatingProcessFolderPath endswith "\\excel.exe" or InitiatingProcessFolderPath endswith "\\expand.exe" or InitiatingProcessFolderPath endswith "\\find.exe" or InitiatingProcessFolderPath endswith "\\findstr.exe" or InitiatingProcessFolderPath endswith "\\forfiles.exe" or InitiatingProcessFolderPath endswith "\\gpupdate.exe" or InitiatingProcessFolderPath endswith "\\hh.exe" or InitiatingProcessFolderPath endswith "\\installutil.exe" or InitiatingProcessFolderPath endswith "\\lync.exe" or InitiatingProcessFolderPath endswith "\\makecab.exe" or InitiatingProcessFolderPath endswith "\\mDNSResponder.exe" or InitiatingProcessFolderPath endswith "\\monitoringhost.exe" or InitiatingProcessFolderPath endswith "\\msbuild.exe" or InitiatingProcessFolderPath endswith "\\mshta.exe" or InitiatingProcessFolderPath endswith "\\mspaint.exe" or InitiatingProcessFolderPath endswith "\\outlook.exe" or InitiatingProcessFolderPath endswith "\\ping.exe" or InitiatingProcessFolderPath endswith "\\provtool.exe" or InitiatingProcessFolderPath endswith "\\python.exe" or InitiatingProcessFolderPath endswith "\\regsvr32.exe" or InitiatingProcessFolderPath endswith "\\robocopy.exe" or InitiatingProcessFolderPath endswith "\\runonce.exe" or InitiatingProcessFolderPath endswith "\\sapcimc.exe" or InitiatingProcessFolderPath endswith "\\smartscreen.exe" or InitiatingProcessFolderPath endswith "\\spoolsv.exe" or InitiatingProcessFolderPath endswith "\\tstheme.exe" or InitiatingProcessFolderPath endswith "\\userinit.exe" or InitiatingProcessFolderPath endswith "\\vssadmin.exe" or InitiatingProcessFolderPath endswith "\\vssvc.exe" or InitiatingProcessFolderPath endswith "\\w3wp.exe" or InitiatingProcessFolderPath endswith "\\winscp.exe" or InitiatingProcessFolderPath endswith "\\winword.exe" or InitiatingProcessFolderPath endswith "\\wmic.exe" or InitiatingProcessFolderPath endswith "\\wscript.exe"
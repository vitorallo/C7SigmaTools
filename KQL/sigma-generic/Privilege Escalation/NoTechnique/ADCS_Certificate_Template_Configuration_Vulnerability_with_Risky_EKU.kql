// Title: ADCS Certificate Template Configuration Vulnerability with Risky EKU
// Author: Orlinum , BlueDefenZer
// Date: 2021-11-17
// Level: high
// Description: Detects certificate creation with template allowing risk permission subject and risky EKUThis table contains security-related events, including event IDs 4898 and 4899. To query for events related to certificate services loaded a template or updated a template, filter on the EventID field.
// Tags: attack.privilege-escalation, attack.credential-access
// ================================================================== 

SecurityEvent
| where ((TemplateContent contains "1.3.6.1.5.5.7.3.2" or TemplateContent contains "1.3.6.1.5.2.3.4" or TemplateContent contains "1.3.6.1.4.1.311.20.2.2" or TemplateContent contains "2.5.29.37.0") and TemplateContent contains "CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT") or ((NewTemplateContent contains "1.3.6.1.5.5.7.3.2" or NewTemplateContent contains "1.3.6.1.5.2.3.4" or NewTemplateContent contains "1.3.6.1.4.1.311.20.2.2" or NewTemplateContent contains "2.5.29.37.0") and NewTemplateContent contains "CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT")
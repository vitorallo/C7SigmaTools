// Title: Creation Of a Suspicious ADS File Outside a Browser Download
// Author: frack113
// Date: 2022-10-22
// Level: medium
// Description: Detects the creation of a suspicious ADS (Alternate Data Stream) file by software other than browsersThe SecurityEvent table in Microsoft Sentinel contains Windows security event logs. To query this table, ensure that you have the necessary connectors set up in Sentinel to collect Windows security event logs.
// Tags: attack.defense-evasion
// ================================================================== 

SecurityEvent
| where (Contents startswith "[ZoneTransfer]  ZoneId=3" and (TargetFilename contains ".exe" or TargetFilename contains ".scr" or TargetFilename contains ".bat" or TargetFilename contains ".cmd" or TargetFilename contains ".docx" or TargetFilename contains ".hta" or TargetFilename contains ".jse" or TargetFilename contains ".lnk" or TargetFilename contains ".pptx" or TargetFilename contains ".ps" or TargetFilename contains ".reg" or TargetFilename contains ".sct" or TargetFilename contains ".vb" or TargetFilename contains ".wsc" or TargetFilename contains ".wsf" or TargetFilename contains ".xlsx") and TargetFilename endswith ":Zone.Identifier") and (not((InitiatingProcessFolderPath endswith "\\brave.exe" or (InitiatingProcessFolderPath in~ ("C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe", "C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe")) or (InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\" or InitiatingProcessFolderPath endswith "\\WindowsApps\\MicrosoftEdge.exe" or (InitiatingProcessFolderPath in~ ("C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe", "C:\\Program Files\\Microsoft\\Edge\\Application\\msedge.exe"))) or ((InitiatingProcessFolderPath endswith "\\msedge.exe" or InitiatingProcessFolderPath endswith "\\msedgewebview2.exe") and (InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\Microsoft\\EdgeCore\\" or InitiatingProcessFolderPath startswith "C:\\Program Files\\Microsoft\\EdgeCore\\")) or (InitiatingProcessFolderPath in~ ("C:\\Program Files\\Mozilla Firefox\\firefox.exe", "C:\\Program Files (x86)\\Mozilla Firefox\\firefox.exe")) or (InitiatingProcessFolderPath in~ ("C:\\Program Files (x86)\\Internet Explorer\\iexplore.exe", "C:\\Program Files\\Internet Explorer\\iexplore.exe")) or InitiatingProcessFolderPath endswith "\\maxthon.exe" or InitiatingProcessFolderPath endswith "\\opera.exe" or InitiatingProcessFolderPath endswith "\\safari.exe" or InitiatingProcessFolderPath endswith "\\seamonkey.exe" or (InitiatingProcessFolderPath endswith "\\SnippingTool\\SnippingTool.exe" and InitiatingProcessFolderPath startswith "C:\\Program Files\\WindowsApps\\Microsoft.ScreenSketch_" and (TargetFilename contains "\\AppData\\Local\\Packages\\Microsoft.ScreenSketch_" and TargetFilename contains "\\TempState\\Screenshot ") and TargetFilename endswith ".png:Zone.Identifier" and TargetFilename startswith "C:\\Users\\") or InitiatingProcessFolderPath endswith "\\vivaldi.exe" or InitiatingProcessFolderPath endswith "\\whale.exe")))
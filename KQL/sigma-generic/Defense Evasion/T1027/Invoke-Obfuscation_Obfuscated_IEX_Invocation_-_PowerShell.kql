// Title: Invoke-Obfuscation Obfuscated IEX Invocation - PowerShell
// Author: Daniel Bohannon (@Mandiant/@FireEye), oscd.community
// Date: 2019-11-08
// Level: high
// Description: Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the following code block \u2014The SecurityEvent table in Microsoft Sentinel contains Windows security event logs, which can include information about PowerShell script execution. Ensure that the Windows Security Events data connector is enabled in Sentinel to have access to this table.
// Tags: attack.defense-evasion, attack.t1027, attack.execution, attack.t1059.001
// ================================================================== 

SecurityEvent
| where ScriptBlockText matches regex "\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\[" or ScriptBlockText matches regex "\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\[" or ScriptBlockText matches regex "\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\[" or ScriptBlockText matches regex "\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}" or ScriptBlockText matches regex "\\*mdr\\*\\W\\s*\\)\\.Name" or ScriptBlockText matches regex "\\$VerbosePreference\\.ToString\\("
// Title: Invoke-Obfuscation Obfuscated IEX Invocation - System
// Author: Daniel Bohannon (@Mandiant/@FireEye), oscd.community
// Date: 2019-11-08
// Level: high
// Description: Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the code block linked in the referencesThe SecurityEvent table in Microsoft Sentinel contains Windows security event logs. Ensure that the Windows Security Events data connector is enabled in Sentinel to have access to this table.
// Tags: attack.defense-evasion, attack.t1027
// ================================================================== 

SecurityEvent
| where ImagePath matches regex "\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\[" or ImagePath matches regex "\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\[" or ImagePath matches regex "\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\[" or ImagePath matches regex "\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}" or ImagePath matches regex "\\\\*mdr\\*\\W\\s*\\)\\.Name" or ImagePath matches regex "\\$VerbosePreference\\.ToString\\(" or ImagePath matches regex "\\String\\]\\s*\\$VerbosePreference"
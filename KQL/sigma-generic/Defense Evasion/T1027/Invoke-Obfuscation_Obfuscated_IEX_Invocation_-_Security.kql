// Title: Invoke-Obfuscation Obfuscated IEX Invocation - Security
// Author: Daniel Bohannon (@Mandiant/@FireEye), oscd.community
// Date: 2019-11-08
// Level: high
// Description: Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the code block linked in the referencesThis table contains security-related events, including event ID 4697. Ensure that the Windows Security Events data connector is enabled in Microsoft Sentinel to have access to this table.
// Tags: attack.defense-evasion, attack.t1027
// ================================================================== 

SecurityEvent
| where ServiceFileName matches regex "\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\[" or ServiceFileName matches regex "\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\[" or ServiceFileName matches regex "\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\[" or ServiceFileName matches regex "\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}" or ServiceFileName matches regex "\\\\*mdr\\*\\W\\s*\\)\\.Name" or ServiceFileName matches regex "\\$VerbosePreference\\.ToString\\(" or ServiceFileName matches regex "\\String\\]\\s*\\$VerbosePreference"
// Title: Invoke-Obfuscation Obfuscated IEX Invocation - PowerShell Module
// Author: Daniel Bohannon (@Mandiant/@FireEye), oscd.community
// Date: 2019-11-08
// Level: high
// Description: Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the code block cited in the reference section belowThis table contains security event logs from Windows machines. Make sure to have the Windows Security Events connector enabled in Microsoft Sentinel to collect these logs.
// Tags: attack.defense-evasion, attack.t1027, attack.execution, attack.t1059.001
// ================================================================== 

SecurityEvent
| where Payload matches regex "\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\[" or Payload matches regex "\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\[" or Payload matches regex "\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\[" or Payload matches regex "\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}" or Payload matches regex "\\*mdr\\*\\W\\s*\\)\\.Name" or Payload matches regex "\\$VerbosePreference\\.ToString\\(" or Payload matches regex "\\[String\\]\\s*\\$VerbosePreference"
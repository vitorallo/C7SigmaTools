// Title: Windows Filtering Platform Blocked Connection From EDR Agent Binary
// Author: @gott_cyber
// Date: 2024-01-08
// Level: high
// Description: Detects a Windows Filtering Platform (WFP) blocked connection event involving common Endpoint Detection and Response (EDR) agents.
// Adversaries may use WFP filters to prevent Endpoint Detection and Response (EDR) agents from reporting security events.
// The SecurityEvent table in Microsoft Sentinel contains security-related events and logs from Windows machines. To ensure this table is populated, make sure to have the Microsoft Monitoring Agent installed on the Windows machines and properly configured to send security event logs to Sentinel.
// Tags: attack.defense-evasion, attack.t1562
// ================================================================== 

SecurityEvent
| where Application endswith "\\AmSvc.exe" or Application endswith "\\cb.exe" or Application endswith "\\CETASvc.exe" or Application endswith "\\CNTAoSMgr.exe" or Application endswith "\\CrAmTray.exe" or Application endswith "\\CrsSvc.exe" or Application endswith "\\CSFalconContainer.exe" or Application endswith "\\CSFalconService.exe" or Application endswith "\\CybereasonAV.exe" or Application endswith "\\CylanceSvc.exe" or Application endswith "\\cyserver.exe" or Application endswith "\\CyveraService.exe" or Application endswith "\\CyvrFsFlt.exe" or Application endswith "\\EIConnector.exe" or Application endswith "\\elastic-agent.exe" or Application endswith "\\elastic-endpoint.exe" or Application endswith "\\EndpointBasecamp.exe" or Application endswith "\\ExecutionPreventionSvc.exe" or Application endswith "\\filebeat.exe" or Application endswith "\\fortiedr.exe" or Application endswith "\\hmpalert.exe" or Application endswith "\\hurukai.exe" or Application endswith "\\LogProcessorService.exe" or Application endswith "\\mcsagent.exe" or Application endswith "\\mcsclient.exe" or Application endswith "\\MsMpEng.exe" or Application endswith "\\MsSense.exe" or Application endswith "\\Ntrtscan.exe" or Application endswith "\\PccNTMon.exe" or Application endswith "\\QualysAgent.exe" or Application endswith "\\RepMgr.exe" or Application endswith "\\RepUtils.exe" or Application endswith "\\RepUx.exe" or Application endswith "\\RepWAV.exe" or Application endswith "\\RepWSC.exe" or Application endswith "\\sedservice.exe" or Application endswith "\\SenseCncProxy.exe" or Application endswith "\\SenseIR.exe" or Application endswith "\\SenseNdr.exe" or Application endswith "\\SenseSampleUploader.exe" or Application endswith "\\SentinelAgent.exe" or Application endswith "\\SentinelAgentWorker.exe" or Application endswith "\\SentinelBrowserNativeHost.exe" or Application endswith "\\SentinelHelperService.exe" or Application endswith "\\SentinelServiceHost.exe" or Application endswith "\\SentinelStaticEngine.exe" or Application endswith "\\SentinelStaticEngineScanner.exe" or Application endswith "\\sfc.exe" or Application endswith "\\sophos ui.exe" or Application endswith "\\sophosfilescanner.exe" or Application endswith "\\sophosfs.exe" or Application endswith "\\sophoshealth.exe" or Application endswith "\\sophosips.exe" or Application endswith "\\sophosLivequeryservice.exe" or Application endswith "\\sophosnetfilter.exe" or Application endswith "\\sophosntpservice.exe" or Application endswith "\\sophososquery.exe" or Application endswith "\\sspservice.exe" or Application endswith "\\TaniumClient.exe" or Application endswith "\\TaniumCX.exe" or Application endswith "\\TaniumDetectEngine.exe" or Application endswith "\\TMBMSRV.exe" or Application endswith "\\TmCCSF.exe" or Application endswith "\\TmListen.exe" or Application endswith "\\TmWSCSvc.exe" or Application endswith "\\Traps.exe" or Application endswith "\\winlogbeat.exe" or Application endswith "\\WSCommunicator.exe" or Application endswith "\\xagt.exe"
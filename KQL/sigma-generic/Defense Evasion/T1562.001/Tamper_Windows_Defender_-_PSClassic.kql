// Title: Tamper Windows Defender - PSClassic
// Author: frack113, Nasreddine Bencherchali (Nextron Systems)
// Date: 2021-06-07
// Level: high
// Description: Attempting to disable scheduled scanning and other parts of Windows Defender ATP or set default actions to allow.The SecurityEvent table in Microsoft Sentinel contains Windows security event logs. Ensure that the Windows Security events data connector is enabled in Sentinel to have this table available for querying.
// Tags: attack.defense-evasion, attack.t1562.001
// ================================================================== 

SecurityEvent
| where Data contains "Set-MpPreference" and ((Data contains "HighThreatDefaultAction Allow" or Data contains "htdefac Allow" or Data contains "LowThreatDefaultAction Allow" or Data contains "ltdefac Allow" or Data contains "ModerateThreatDefaultAction Allow" or Data contains "mtdefac Allow" or Data contains "SevereThreatDefaultAction Allow" or Data contains "stdefac Allow") or (Data contains "-dbaf $true" or Data contains "-dbaf 1" or Data contains "-dbm $true" or Data contains "-dbm 1" or Data contains "-dips $true" or Data contains "-dips 1" or Data contains "-DisableArchiveScanning $true" or Data contains "-DisableArchiveScanning 1" or Data contains "-DisableBehaviorMonitoring $true" or Data contains "-DisableBehaviorMonitoring 1" or Data contains "-DisableBlockAtFirstSeen $true" or Data contains "-DisableBlockAtFirstSeen 1" or Data contains "-DisableCatchupFullScan $true" or Data contains "-DisableCatchupFullScan 1" or Data contains "-DisableCatchupQuickScan $true" or Data contains "-DisableCatchupQuickScan 1" or Data contains "-DisableIntrusionPreventionSystem $true" or Data contains "-DisableIntrusionPreventionSystem 1" or Data contains "-DisableIOAVProtection $true" or Data contains "-DisableIOAVProtection 1" or Data contains "-DisableRealtimeMonitoring $true" or Data contains "-DisableRealtimeMonitoring 1" or Data contains "-DisableRemovableDriveScanning $true" or Data contains "-DisableRemovableDriveScanning 1" or Data contains "-DisableScanningMappedNetworkDrivesForFullScan $true" or Data contains "-DisableScanningMappedNetworkDrivesForFullScan 1" or Data contains "-DisableScanningNetworkFiles $true" or Data contains "-DisableScanningNetworkFiles 1" or Data contains "-DisableScriptScanning $true" or Data contains "-DisableScriptScanning 1" or Data contains "-MAPSReporting $false" or Data contains "-MAPSReporting 0" or Data contains "-drdsc $true" or Data contains "-drdsc 1" or Data contains "-drtm $true" or Data contains "-drtm 1" or Data contains "-dscrptsc $true" or Data contains "-dscrptsc 1" or Data contains "-dsmndf $true" or Data contains "-dsmndf 1" or Data contains "-dsnf $true" or Data contains "-dsnf 1" or Data contains "-dss $true" or Data contains "-dss 1"))
// Title: Windows Defender Exploit Guard Tamper
// Author: Nasreddine Bencherchali (Nextron Systems)
// Date: 2022-08-05
// Level: high
// Description: Detects when someone is adding or removing applications or folders from exploit guard "ProtectedFolders" or "AllowedApplications"
// The SecurityEvent table in Microsoft Sentinel contains Windows security event logs. To query this table for events related to Windows Defender, you can filter on the 'Channel' field for 'Microsoft-Windows-Security-Auditing' and the 'EventID' field for events related to Windows Defender (e.g., EventID 1006 for Windows Defender scan events). Ensure that the Windows Defender ATP connector is enabled in Sentinel to collect these logs.
// Tags: attack.defense-evasion, attack.t1562.001
// ================================================================== 

SecurityEvent
| where (NewValue contains "\\Windows Defender\\Windows Defender Exploit Guard\\Controlled Folder Access\\AllowedApplications\\" and (NewValue contains "\\Users\\Public\\" or NewValue contains "\\AppData\\Local\\Temp\\" or NewValue contains "\\Desktop\\" or NewValue contains "\\PerfLogs\\" or NewValue contains "\\Windows\\Temp\\")) or OldValue contains "\\Windows Defender\\Windows Defender Exploit Guard\\Controlled Folder Access\\ProtectedFolders\\"
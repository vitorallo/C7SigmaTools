// Title: Tamper Windows Defender - ScriptBlockLogging
// Author: frack113, elhoim, Tim Shelton (fps, alias support), Swachchhanda Shrawan Poudel, Nasreddine Bencherchali (Nextron Systems)
// Date: 2022-01-16
// Level: high
// Description: Detects PowerShell scripts attempting to disable scheduled scanning and other parts of Windows Defender ATP or set default actions to allow.This table contains security-related events from Windows machines. Ensure that the Windows Security Events data connector is enabled in Microsoft Sentinel to query this table.
// Tags: attack.defense-evasion, attack.t1562.001
// ================================================================== 

SecurityEvent
| where ((ScriptBlockText contains "-dbaf $true" or ScriptBlockText contains "-dbaf 1" or ScriptBlockText contains "-dbm $true" or ScriptBlockText contains "-dbm 1" or ScriptBlockText contains "-dips $true" or ScriptBlockText contains "-dips 1" or ScriptBlockText contains "-DisableArchiveScanning $true" or ScriptBlockText contains "-DisableArchiveScanning 1" or ScriptBlockText contains "-DisableBehaviorMonitoring $true" or ScriptBlockText contains "-DisableBehaviorMonitoring 1" or ScriptBlockText contains "-DisableBlockAtFirstSeen $true" or ScriptBlockText contains "-DisableBlockAtFirstSeen 1" or ScriptBlockText contains "-DisableCatchupFullScan $true" or ScriptBlockText contains "-DisableCatchupFullScan 1" or ScriptBlockText contains "-DisableCatchupQuickScan $true" or ScriptBlockText contains "-DisableCatchupQuickScan 1" or ScriptBlockText contains "-DisableIntrusionPreventionSystem $true" or ScriptBlockText contains "-DisableIntrusionPreventionSystem 1" or ScriptBlockText contains "-DisableIOAVProtection $true" or ScriptBlockText contains "-DisableIOAVProtection 1" or ScriptBlockText contains "-DisableRealtimeMonitoring $true" or ScriptBlockText contains "-DisableRealtimeMonitoring 1" or ScriptBlockText contains "-DisableRemovableDriveScanning $true" or ScriptBlockText contains "-DisableRemovableDriveScanning 1" or ScriptBlockText contains "-DisableScanningMappedNetworkDrivesForFullScan $true" or ScriptBlockText contains "-DisableScanningMappedNetworkDrivesForFullScan 1" or ScriptBlockText contains "-DisableScanningNetworkFiles $true" or ScriptBlockText contains "-DisableScanningNetworkFiles 1" or ScriptBlockText contains "-DisableScriptScanning $true" or ScriptBlockText contains "-DisableScriptScanning 1" or ScriptBlockText contains "-MAPSReporting $false" or ScriptBlockText contains "-MAPSReporting 0" or ScriptBlockText contains "-drdsc $true" or ScriptBlockText contains "-drdsc 1" or ScriptBlockText contains "-drtm $true" or ScriptBlockText contains "-drtm 1" or ScriptBlockText contains "-dscrptsc $true" or ScriptBlockText contains "-dscrptsc 1" or ScriptBlockText contains "-dsmndf $true" or ScriptBlockText contains "-dsmndf 1" or ScriptBlockText contains "-dsnf $true" or ScriptBlockText contains "-dsnf 1" or ScriptBlockText contains "-dss $true" or ScriptBlockText contains "-dss 1") and ScriptBlockText contains "Set-MpPreference") or (ScriptBlockText contains "Set-MpPreference" and (ScriptBlockText contains "HighThreatDefaultAction Allow" or ScriptBlockText contains "htdefac Allow" or ScriptBlockText contains "LowThreatDefaultAction Allow" or ScriptBlockText contains "ltdefac Allow" or ScriptBlockText contains "ModerateThreatDefaultAction Allow" or ScriptBlockText contains "mtdefac Allow" or ScriptBlockText contains "SevereThreatDefaultAction Allow" or ScriptBlockText contains "stdefac Allow"))
// Title: CobaltStrike Named Pipe Patterns
// Author: Florian Roth (Nextron Systems), Christian Burkard (Nextron Systems)
// Date: 2021-07-30
// Level: high
// Description: Detects the creation of a named pipe with a pattern found in CobaltStrike malleable C2 profilesThis table contains Sysmon events, including Named Pipe Events (Event ID 17 and Event ID 18) mentioned in the logsource section. To have this table present in Sentinel, make sure to have Sysmon installed on the Windows machines and configured to log the necessary events.
// Tags: attack.defense-evasion, attack.privilege-escalation, attack.t1055, stp.1k
// ================================================================== 

SysmonEvent
| where ((PipeName endswith "-0," and PipeName startswith "\\Winsock2\\CatalogChangeListener-") or ((PipeName startswith "\\DserNamePipe" or PipeName startswith "\\f4c3" or PipeName startswith "\\f53f" or PipeName startswith "\\fullduplex_" or PipeName startswith "\\mojo.5688.8052.183894939787088877" or PipeName startswith "\\mojo.5688.8052.35780273329370473" or PipeName startswith "\\MsFteWds" or PipeName startswith "\\msrpc_" or PipeName startswith "\\mypipe-f" or PipeName startswith "\\mypipe-h" or PipeName startswith "\\ntsvcs" or PipeName startswith "\\PGMessagePipe" or PipeName startswith "\\rpc_" or PipeName startswith "\\scerpc" or PipeName startswith "\\SearchTextHarvester" or PipeName startswith "\\spoolss" or PipeName startswith "\\win_svc" or PipeName startswith "\\win\\msrpc_" or PipeName startswith "\\windows.update.manager" or PipeName startswith "\\wkssvc") or (PipeName in~ ("\\demoagent_11", "\\demoagent_22")))) and (not((PipeName in~ ("\\wkssvc", "\\spoolss", "\\scerpc", "\\ntsvcs", "\\SearchTextHarvester", "\\PGMessagePipe", "\\MsFteWds")))) and (not(((InitiatingProcessFolderPath contains ":\\Program Files\\Websense\\" or InitiatingProcessFolderPath contains ":\\Program Files (x86)\\Websense\\") and (PipeName startswith "\\DserNamePipeR" or PipeName startswith "\\DserNamePipeW"))))
// Title: Potential Defense Evasion Via Raw Disk Access By Uncommon Tools
// Author: Teymur Kheirkhabarov, oscd.community
// Date: 2019-10-22
// Level: low
// Description: Detects raw disk access using uncommon tools or tools that are located in suspicious locations (heavy filtering is required), which could indicate possible defense evasion attemptsThe SecurityEvent table in Microsoft Sentinel contains raw security event logs from Windows machines. To have this table present, ensure that you have the necessary data connectors set up in Sentinel to collect Windows security event logs.
// Tags: attack.defense-evasion, attack.t1006
// ================================================================== 

SecurityEvent
| where (not((Device contains "floppy" or (InitiatingProcessFolderPath contains ":\\$WINDOWS.~BT\\" or InitiatingProcessFolderPath contains ":\\Program Files (x86)\\" or InitiatingProcessFolderPath contains ":\\Program Files\\" or InitiatingProcessFolderPath contains ":\\Windows\\CCM\\" or InitiatingProcessFolderPath contains ":\\Windows\\explorer.exe" or InitiatingProcessFolderPath contains ":\\Windows\\servicing\\" or InitiatingProcessFolderPath contains ":\\Windows\\SoftwareDistribution\\" or InitiatingProcessFolderPath contains ":\\Windows\\System32\\" or InitiatingProcessFolderPath contains ":\\Windows\\SystemApps\\" or InitiatingProcessFolderPath contains ":\\Windows\\uus\\" or InitiatingProcessFolderPath contains ":\\Windows\\WinSxS\\") or (InitiatingProcessFolderPath contains ":\\Users\\" and InitiatingProcessFolderPath contains "\\AppData\\" and InitiatingProcessFolderPath contains "\\Microsoft\\") or isnull(InitiatingProcessFolderPath) or (InitiatingProcessFolderPath contains ":\\Windows\\Temp\\" and (InitiatingProcessFolderPath endswith "\\Executables\\SSDUpdate.exe" or InitiatingProcessFolderPath endswith "\\HostMetadata\\NVMEHostmetadata.exe")) or (InitiatingProcessFolderPath in~ ("Registry", "System")) or InitiatingProcessFolderPath endswith ":\\Windows\\ImmersiveControlPanel\\SystemSettings.exe" or (InitiatingProcessFolderPath contains ":\\ProgramData\\Microsoft\\Windows Defender\\Platform\\" and InitiatingProcessFolderPath endswith "\\MsMpEng.exe")))) and (not((InitiatingProcessFolderPath contains "\\AppData\\Local\\Keybase\\upd.exe" or (InitiatingProcessFolderPath contains "\\AppData\\Local\\GitHubDesktop\\app-" and InitiatingProcessFolderPath endswith "\\resources\\app\\git\\mingw64\\bin\\git.exe") or (InitiatingProcessFolderPath contains ":\\Windows\\Temp\\asgard2-agent\\" and InitiatingProcessFolderPath endswith "\\thor.exe"))))
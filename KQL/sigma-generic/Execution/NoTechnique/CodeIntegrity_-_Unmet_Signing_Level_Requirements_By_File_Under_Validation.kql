// Title: CodeIntegrity - Unmet Signing Level Requirements By File Under Validation
// Author: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
// Date: 2022-01-20
// Level: low
// Description: Detects attempted file load events that did not meet the signing level requirements. It often means the file's signature is revoked or a signature with the Lifetime Signing EKU has expired.
// This event is best correlated with EID 3089 to determine the error of the validation.
// The SecurityEvent table in Microsoft Sentinel contains Windows security event logs, which may include code integrity operational events. Ensure that the Windows Security Events connector is enabled in Sentinel to have this table available for querying.
// Tags: attack.execution
// ================================================================== 

SecurityEvent
| where (not((FileNameBuffer contains "\\Windows\\assembly\\GAC\\" and ProcessNameBuffer contains "\\Windows\\Microsoft.NET\\" and ProcessNameBuffer endswith "\\mscorsvw.exe" and RequestedPolicy == 8))) and (not(((FileNameBuffer contains "\\Windows\\System32\\DriverStore\\FileRepository\\" and FileNameBuffer endswith "\\igd10iumd64.dll" and RequestedPolicy == 7) or ((FileNameBuffer endswith "\\Program Files\\Avast Software\\Avast\\aswAMSI.dll" or FileNameBuffer endswith "\\Program Files (x86)\\Avast Software\\Avast\\aswAMSI.dll") and (RequestedPolicy in~ ("8", "12"))) or (FileNameBuffer endswith "\\Program Files\\Bonjour\\mdnsNSP.dll" and (ProcessNameBuffer endswith "\\Windows\\System32\\svchost.exe" or ProcessNameBuffer endswith "\\Windows\\System32\\SIHClient.exe") and (RequestedPolicy in~ ("8", "12"))) or FileNameBuffer endswith "\\Program Files\\comodo\\comodo internet security\\amsiprovider_x64.dll" or (FileNameBuffer endswith "\\Program Files\\DTrace\\dtrace.dll" and ProcessNameBuffer endswith "\\Windows\\System32\\svchost.exe" and RequestedPolicy == 12) or (FileNameBuffer endswith "\\Windows\\System32\\nvspcap64.dll" and (ProcessNameBuffer endswith "\\AppData\\Local\\Keybase\\Gui\\Keybase.exe" or ProcessNameBuffer endswith "\\Microsoft\\Teams\\stage\\Teams.exe") and RequestedPolicy == 8) or FileNameBuffer endswith "\\Program Files\\ESET\\ESET Security\\eamsi.dll" or ((FileNameBuffer endswith "\\Mozilla Firefox\\mozavcodec.dll" or FileNameBuffer endswith "\\Mozilla Firefox\\mozavutil.dll") and ProcessNameBuffer endswith "\\Mozilla Firefox\\firefox.exe" and RequestedPolicy == 8) or (FileNameBuffer contains "\\Program Files\\Google\\Drive File Stream\\" and FileNameBuffer endswith "\\crashpad_handler.exe" and ProcessNameBuffer endswith "\\Windows\\ImmersiveControlPanel\\SystemSettings.exe" and RequestedPolicy == 8) or ((ProcessNameBuffer contains "\\Kaspersky Lab\\" and ProcessNameBuffer contains "\\avp.exe") or (FileNameBuffer contains "\\Kaspersky Lab\\" and FileNameBuffer contains "\\antimalware_provider.dll")) or (FileNameBuffer endswith "\\Program Files\\McAfee\\Endpoint Security\\Threat Prevention\\MfeAmsiProvider.dll" or FileNameBuffer endswith "\\Program Files\\McAfee\\MfeAV\\AMSIExt.dll") or FileNameBuffer endswith "\\Program Files\\National Instruments\\Shared\\mDNS Responder\\nimdnsNSP.dll " or (FileNameBuffer contains "\\Microsoft Office\\root\\vfs\\ProgramFilesCommonX64\\Microsoft Shared\\OFFICE" and FileNameBuffer endswith "\\MSOXMLMF.DLL" and RequestedPolicy == 7) or FileNameBuffer contains "\\National Instruments\\Shared\\mDNS Responder\\" or (FileNameBuffer contains "\\Program Files\\SentinelOne\\Sentinel Agent" or ProcessNameBuffer contains "\\Program Files\\SentinelOne\\Sentinel Agent") or (FileNameBuffer endswith "\\Windows\\System32\\nvspcap64.dll" and ProcessNameBuffer contains "\\AppData\\Local\\slack\\app-" and ProcessNameBuffer endswith "\\slack.exe" and RequestedPolicy == 8) or (FileNameBuffer endswith "\\Trend Micro\\Client Server Security Agent\\perficrcperfmonmgr.dll" and RequestedPolicy == 8))))
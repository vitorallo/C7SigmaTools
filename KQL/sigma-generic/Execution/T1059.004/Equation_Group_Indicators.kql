// Title: Equation Group Indicators
// Author: Florian Roth (Nextron Systems)
// Date: 2017-04-09
// Level: high
// Description: Detects suspicious shell commands used in various Equation Group scripts and toolsThis table contains Linux audit logs, which can be queried in Microsoft Sentinel. Ensure that the Linux machines are onboarded to Sentinel and the necessary data connectors are set up to collect Linux audit logs.
// Tags: attack.execution, attack.g0020, attack.t1059.004
// ================================================================== 

LinuxAuditLogs
| where "chown root*chmod 4777 " or "cp /bin/sh .;chown" or "chmod 4777 /tmp/.scsi/dev/bin/gsh" or "chown root:root /tmp/.scsi/dev/bin/" or "chown root:root x;" or "/bin/telnet locip locport < /dev/console | /bin/sh" or "/tmp/ratload" or "ewok -t " or "xspy -display " or "cat > /dev/tcp/127.0.0.1/80 <<END" or "rm -f /current/tmp/ftshell.latest" or "ghost_* -v " or " --wipe > /dev/null" or "ping -c 2 *; grep * /proc/net/arp >/tmp/gx" or "iptables * OUTPUT -p tcp -d 127.0.0.1 --tcp-flags RST RST -j DROP;" or "> /var/log/audit/audit.log; rm -f ." or "cp /var/log/audit/audit.log .tmp" or "sh >/dev/tcp/* <&1 2>&1" or "ncat -vv -l -p * <" or "nc -vv -l -p * <" or "< /dev/console | uudecode && uncompress" or "sendmail -osendmail;chmod +x sendmail" or "/usr/bin/wget -O /tmp/a http* && chmod 755 /tmp/cron" or "chmod 666 /var/run/utmp~" or "chmod 700 nscd crond" or "cp /etc/shadow /tmp/." or "</dev/console |uudecode > /dev/null 2>&1 && uncompress" or "chmod 700 jp&&netstat -an|grep" or "uudecode > /dev/null 2>&1 && uncompress -f * && chmod 755" or "chmod 700 crond" or "wget http*; chmod +x /tmp/sendmail" or "chmod 700 fp sendmail pt" or "chmod 755 /usr/vmsys/bin/pipe" or "chmod -R 755 /usr/vmsys" or "chmod 755 $opbin/*tunnel" or "chmod 700 sendmail" or "chmod 0700 sendmail" or "/usr/bin/wget http*sendmail;chmod +x sendmail;" or "&& telnet * 2>&1 </dev/console"
// Title: Malicious PowerShell Commandlets - PoshModule
// Author: Nasreddine Bencherchali (Nextron Systems)
// Date: 2023-01-20
// Level: high
// Description: Detects Commandlet names from well-known PowerShell exploitation frameworksThis table contains security events from Windows machines. Make sure to have the Windows Security Events connector enabled in Microsoft Sentinel to collect this data.
// Tags: attack.execution, attack.discovery, attack.t1482, attack.t1087, attack.t1087.001, attack.t1087.002, attack.t1069.001, attack.t1069.002, attack.t1069, attack.t1059.001
// ================================================================== 

SecurityEvent
| where Payload contains "Add-Exfiltration" or Payload contains "Add-Persistence" or Payload contains "Add-RegBackdoor" or Payload contains "Add-RemoteRegBackdoor" or Payload contains "Add-ScrnSaveBackdoor" or Payload contains "Check-VM" or Payload contains "ConvertTo-Rc4ByteStream" or Payload contains "Decrypt-Hash" or Payload contains "Disable-ADIDNSNode" or Payload contains "Disable-MachineAccount" or Payload contains "Do-Exfiltration" or Payload contains "Enable-ADIDNSNode" or Payload contains "Enable-MachineAccount" or Payload contains "Enabled-DuplicateToken" or Payload contains "Exploit-Jboss" or Payload contains "Export-ADR" or Payload contains "Export-ADRCSV" or Payload contains "Export-ADRExcel" or Payload contains "Export-ADRHTML" or Payload contains "Export-ADRJSON" or Payload contains "Export-ADRXML" or Payload contains "Find-Fruit" or Payload contains "Find-GPOLocation" or Payload contains "Find-TrustedDocuments" or Payload contains "Get-ADIDNS" or Payload contains "Get-ApplicationHost" or Payload contains "Get-ChromeDump" or Payload contains "Get-ClipboardContents" or Payload contains "Get-FoxDump" or Payload contains "Get-GPPPassword" or Payload contains "Get-IndexedItem" or Payload contains "Get-KerberosAESKey" or Payload contains "Get-Keystrokes" or Payload contains "Get-LSASecret" or Payload contains "Get-MachineAccountAttribute" or Payload contains "Get-MachineAccountCreator" or Payload contains "Get-PassHashes" or Payload contains "Get-RegAlwaysInstallElevated" or Payload contains "Get-RegAutoLogon" or Payload contains "Get-RemoteBootKey" or Payload contains "Get-RemoteCachedCredential" or Payload contains "Get-RemoteLocalAccountHash" or Payload contains "Get-RemoteLSAKey" or Payload contains "Get-RemoteMachineAccountHash" or Payload contains "Get-RemoteNLKMKey" or Payload contains "Get-RickAstley" or Payload contains "Get-Screenshot" or Payload contains "Get-SecurityPackages" or Payload contains "Get-ServiceFilePermission" or Payload contains "Get-ServicePermission" or Payload contains "Get-ServiceUnquoted" or Payload contains "Get-SiteListPassword" or Payload contains "Get-System" or Payload contains "Get-TimedScreenshot" or Payload contains "Get-UnattendedInstallFile" or Payload contains "Get-Unconstrained" or Payload contains "Get-USBKeystrokes" or Payload contains "Get-VaultCredential" or Payload contains "Get-VulnAutoRun" or Payload contains "Get-VulnSchTask" or Payload contains "Grant-ADIDNSPermission" or Payload contains "Gupt-Backdoor" or Payload contains "HTTP-Login" or Payload contains "Install-ServiceBinary" or Payload contains "Install-SSP" or Payload contains "Invoke-ACLScanner" or Payload contains "Invoke-ADRecon" or Payload contains "Invoke-ADSBackdoor" or Payload contains "Invoke-AgentSmith" or Payload contains "Invoke-AllChecks" or Payload contains "Invoke-ARPScan" or Payload contains "Invoke-AzureHound" or Payload contains "Invoke-BackdoorLNK" or Payload contains "Invoke-BadPotato" or Payload contains "Invoke-BetterSafetyKatz" or Payload contains "Invoke-BypassUAC" or Payload contains "Invoke-Carbuncle" or Payload contains "Invoke-Certify" or Payload contains "Invoke-ConPtyShell" or Payload contains "Invoke-CredentialInjection" or Payload contains "Invoke-DAFT" or Payload contains "Invoke-DCSync" or Payload contains "Invoke-DinvokeKatz" or Payload contains "Invoke-DllInjection" or Payload contains "Invoke-DNSUpdate" or Payload contains "Invoke-DomainPasswordSpray" or Payload contains "Invoke-DowngradeAccount" or Payload contains "Invoke-EgressCheck" or Payload contains "Invoke-Eyewitness" or Payload contains "Invoke-FakeLogonScreen" or Payload contains "Invoke-Farmer" or Payload contains "Invoke-Get-RBCD-Threaded" or Payload contains "Invoke-Gopher" or Payload contains "Invoke-Grouper" or Payload contains "Invoke-HandleKatz" or Payload contains "Invoke-ImpersonatedProcess" or Payload contains "Invoke-ImpersonateSystem" or Payload contains "Invoke-InteractiveSystemPowerShell" or Payload contains "Invoke-Internalmonologue" or Payload contains "Invoke-Inveigh" or Payload contains "Invoke-InveighRelay" or Payload contains "Invoke-KrbRelay" or Payload contains "Invoke-LdapSignCheck" or Payload contains "Invoke-Lockless" or Payload contains "Invoke-MalSCCM" or Payload contains "Invoke-Mimikatz" or Payload contains "Invoke-Mimikittenz" or Payload contains "Invoke-MITM6" or Payload contains "Invoke-NanoDump" or Payload contains "Invoke-NetRipper" or Payload contains "Invoke-Nightmare" or Payload contains "Invoke-NinjaCopy" or Payload contains "Invoke-OfficeScrape" or Payload contains "Invoke-OxidResolver" or Payload contains "Invoke-P0wnedshell" or Payload contains "Invoke-Paranoia" or Payload contains "Invoke-PortScan" or Payload contains "Invoke-PoshRatHttp" or Payload contains "Invoke-PostExfil" or Payload contains "Invoke-PowerDump" or Payload contains "Invoke-PowerShellTCP" or Payload contains "Invoke-PowerShellWMI" or Payload contains "Invoke-PPLDump" or Payload contains "Invoke-PsExec" or Payload contains "Invoke-PSInject" or Payload contains "Invoke-PsUaCme" or Payload contains "Invoke-ReflectivePEInjection" or Payload contains "Invoke-ReverseDNSLookup" or Payload contains "Invoke-Rubeus" or Payload contains "Invoke-RunAs" or Payload contains "Invoke-SafetyKatz" or Payload contains "Invoke-SauronEye" or Payload contains "Invoke-SCShell" or Payload contains "Invoke-Seatbelt" or Payload contains "Invoke-ServiceAbuse" or Payload contains "Invoke-ShadowSpray" or Payload contains "Invoke-Sharp" or Payload contains "Invoke-Shellcode" or Payload contains "Invoke-SMBScanner" or Payload contains "Invoke-Snaffler" or Payload contains "Invoke-Spoolsample" or Payload contains "Invoke-SpraySinglePassword" or Payload contains "Invoke-SSHCommand" or Payload contains "Invoke-StandIn" or Payload contains "Invoke-StickyNotesExtract" or Payload contains "Invoke-SystemCommand" or Payload contains "Invoke-Tasksbackdoor" or Payload contains "Invoke-Tater" or Payload contains "Invoke-Thunderfox" or Payload contains "Invoke-ThunderStruck" or Payload contains "Invoke-TokenManipulation" or Payload contains "Invoke-Tokenvator" or Payload contains "Invoke-TotalExec" or Payload contains "Invoke-UrbanBishop" or Payload contains "Invoke-UserHunter" or Payload contains "Invoke-VoiceTroll" or Payload contains "Invoke-Whisker" or Payload contains "Invoke-WinEnum" or Payload contains "Invoke-winPEAS" or Payload contains "Invoke-WireTap" or Payload contains "Invoke-WmiCommand" or Payload contains "Invoke-WMIExec" or Payload contains "Invoke-WScriptBypassUAC" or Payload contains "Invoke-Zerologon" or Payload contains "MailRaider" or Payload contains "New-ADIDNSNode" or Payload contains "New-DNSRecordArray" or Payload contains "New-HoneyHash" or Payload contains "New-InMemoryModule" or Payload contains "New-MachineAccount" or Payload contains "New-SOASerialNumberArray" or Payload contains "Out-Minidump" or Payload contains "Port-Scan" or Payload contains "PowerBreach" or Payload contains "powercat " or Payload contains "PowerUp" or Payload contains "PowerView" or Payload contains "Remove-ADIDNSNode" or Payload contains "Remove-MachineAccount" or Payload contains "Remove-Update" or Payload contains "Rename-ADIDNSNode" or Payload contains "Revoke-ADIDNSPermission" or Payload contains "Set-ADIDNSNode" or Payload contains "Set-MacAttribute" or Payload contains "Set-MachineAccountAttribute" or Payload contains "Set-Wallpaper" or Payload contains "Show-TargetScreen" or Payload contains "Start-CaptureServer" or Payload contains "Start-Dnscat2" or Payload contains "Start-WebcamRecorder" or Payload contains "Veeam-Get-Creds" or Payload contains "VolumeShadowCopyTools"
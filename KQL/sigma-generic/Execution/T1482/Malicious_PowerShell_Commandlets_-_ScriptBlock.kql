// Title: Malicious PowerShell Commandlets - ScriptBlock
// Author: Sean Metcalf, Florian Roth, Bartlomiej Czyz @bczyz1, oscd.community, Nasreddine Bencherchali, Tim Shelton, Mustafa Kaan Demir, Georg Lauenstein, Max Altgelt, Tobias Michalski, Austin Songer
// Date: 2017-03-05
// Level: high
// Description: Detects Commandlet names from well-known PowerShell exploitation frameworksThis table contains Windows security event logs, including script block logging events. Enable the necessary data connectors in Microsoft Sentinel to collect Windows security event logs.
// Tags: attack.execution, attack.discovery, attack.t1482, attack.t1087, attack.t1087.001, attack.t1087.002, attack.t1069.001, attack.t1069.002, attack.t1069, attack.t1059.001
// ================================================================== 

SecurityEvent
| where (ScriptBlockText contains "Add-Exfiltration" or ScriptBlockText contains "Add-Persistence" or ScriptBlockText contains "Add-RegBackdoor" or ScriptBlockText contains "Add-RemoteRegBackdoor" or ScriptBlockText contains "Add-ScrnSaveBackdoor" or ScriptBlockText contains "ConvertTo-Rc4ByteStream" or ScriptBlockText contains "Decrypt-Hash" or ScriptBlockText contains "Disable-ADIDNSNode" or ScriptBlockText contains "Do-Exfiltration" or ScriptBlockText contains "Enable-ADIDNSNode" or ScriptBlockText contains "Enabled-DuplicateToken" or ScriptBlockText contains "Exploit-Jboss" or ScriptBlockText contains "Export-ADRCSV" or ScriptBlockText contains "Export-ADRExcel" or ScriptBlockText contains "Export-ADRHTML" or ScriptBlockText contains "Export-ADRJSON" or ScriptBlockText contains "Export-ADRXML" or ScriptBlockText contains "Find-Fruit" or ScriptBlockText contains "Find-GPOLocation" or ScriptBlockText contains "Find-TrustedDocuments" or ScriptBlockText contains "Get-ADIDNSNodeAttribute" or ScriptBlockText contains "Get-ADIDNSNodeOwner" or ScriptBlockText contains "Get-ADIDNSNodeTombstoned" or ScriptBlockText contains "Get-ADIDNSPermission" or ScriptBlockText contains "Get-ADIDNSZone" or ScriptBlockText contains "Get-ChromeDump" or ScriptBlockText contains "Get-ClipboardContents" or ScriptBlockText contains "Get-FoxDump" or ScriptBlockText contains "Get-GPPPassword" or ScriptBlockText contains "Get-IndexedItem" or ScriptBlockText contains "Get-KerberosAESKey" or ScriptBlockText contains "Get-Keystrokes" or ScriptBlockText contains "Get-LSASecret" or ScriptBlockText contains "Get-PassHashes" or ScriptBlockText contains "Get-RegAlwaysInstallElevated" or ScriptBlockText contains "Get-RegAutoLogon" or ScriptBlockText contains "Get-RemoteBootKey" or ScriptBlockText contains "Get-RemoteCachedCredential" or ScriptBlockText contains "Get-RemoteLocalAccountHash" or ScriptBlockText contains "Get-RemoteLSAKey" or ScriptBlockText contains "Get-RemoteMachineAccountHash" or ScriptBlockText contains "Get-RemoteNLKMKey" or ScriptBlockText contains "Get-RickAstley" or ScriptBlockText contains "Get-SecurityPackages" or ScriptBlockText contains "Get-ServiceFilePermission" or ScriptBlockText contains "Get-ServicePermission" or ScriptBlockText contains "Get-ServiceUnquoted" or ScriptBlockText contains "Get-SiteListPassword" or ScriptBlockText contains "Get-System" or ScriptBlockText contains "Get-TimedScreenshot" or ScriptBlockText contains "Get-UnattendedInstallFile" or ScriptBlockText contains "Get-Unconstrained" or ScriptBlockText contains "Get-USBKeystrokes" or ScriptBlockText contains "Get-VaultCredential" or ScriptBlockText contains "Get-VulnAutoRun" or ScriptBlockText contains "Get-VulnSchTask" or ScriptBlockText contains "Grant-ADIDNSPermission" or ScriptBlockText contains "Gupt-Backdoor" or ScriptBlockText contains "Invoke-ACLScanner" or ScriptBlockText contains "Invoke-ADRecon" or ScriptBlockText contains "Invoke-ADSBackdoor" or ScriptBlockText contains "Invoke-AgentSmith" or ScriptBlockText contains "Invoke-AllChecks" or ScriptBlockText contains "Invoke-ARPScan" or ScriptBlockText contains "Invoke-AzureHound" or ScriptBlockText contains "Invoke-BackdoorLNK" or ScriptBlockText contains "Invoke-BadPotato" or ScriptBlockText contains "Invoke-BetterSafetyKatz" or ScriptBlockText contains "Invoke-BypassUAC" or ScriptBlockText contains "Invoke-Carbuncle" or ScriptBlockText contains "Invoke-Certify" or ScriptBlockText contains "Invoke-ConPtyShell" or ScriptBlockText contains "Invoke-CredentialInjection" or ScriptBlockText contains "Invoke-DAFT" or ScriptBlockText contains "Invoke-DCSync" or ScriptBlockText contains "Invoke-DinvokeKatz" or ScriptBlockText contains "Invoke-DllInjection" or ScriptBlockText contains "Invoke-DNSUpdate" or ScriptBlockText contains "Invoke-DomainPasswordSpray" or ScriptBlockText contains "Invoke-DowngradeAccount" or ScriptBlockText contains "Invoke-EgressCheck" or ScriptBlockText contains "Invoke-Eyewitness" or ScriptBlockText contains "Invoke-FakeLogonScreen" or ScriptBlockText contains "Invoke-Farmer" or ScriptBlockText contains "Invoke-Get-RBCD-Threaded" or ScriptBlockText contains "Invoke-Gopher" or ScriptBlockText contains "Invoke-Grouper" or ScriptBlockText contains "Invoke-HandleKatz" or ScriptBlockText contains "Invoke-ImpersonatedProcess" or ScriptBlockText contains "Invoke-ImpersonateSystem" or ScriptBlockText contains "Invoke-InteractiveSystemPowerShell" or ScriptBlockText contains "Invoke-Internalmonologue" or ScriptBlockText contains "Invoke-Inveigh" or ScriptBlockText contains "Invoke-InveighRelay" or ScriptBlockText contains "Invoke-KrbRelay" or ScriptBlockText contains "Invoke-LdapSignCheck" or ScriptBlockText contains "Invoke-Lockless" or ScriptBlockText contains "Invoke-MalSCCM" or ScriptBlockText contains "Invoke-Mimikatz" or ScriptBlockText contains "Invoke-Mimikittenz" or ScriptBlockText contains "Invoke-MITM6" or ScriptBlockText contains "Invoke-NanoDump" or ScriptBlockText contains "Invoke-NetRipper" or ScriptBlockText contains "Invoke-Nightmare" or ScriptBlockText contains "Invoke-NinjaCopy" or ScriptBlockText contains "Invoke-OfficeScrape" or ScriptBlockText contains "Invoke-OxidResolver" or ScriptBlockText contains "Invoke-P0wnedshell" or ScriptBlockText contains "Invoke-Paranoia" or ScriptBlockText contains "Invoke-PortScan" or ScriptBlockText contains "Invoke-PoshRatHttp" or ScriptBlockText contains "Invoke-PostExfil" or ScriptBlockText contains "Invoke-PowerDump" or ScriptBlockText contains "Invoke-PowerShellTCP" or ScriptBlockText contains "Invoke-PowerShellWMI" or ScriptBlockText contains "Invoke-PPLDump" or ScriptBlockText contains "Invoke-PsExec" or ScriptBlockText contains "Invoke-PSInject" or ScriptBlockText contains "Invoke-PsUaCme" or ScriptBlockText contains "Invoke-ReflectivePEInjection" or ScriptBlockText contains "Invoke-ReverseDNSLookup" or ScriptBlockText contains "Invoke-Rubeus" or ScriptBlockText contains "Invoke-RunAs" or ScriptBlockText contains "Invoke-SafetyKatz" or ScriptBlockText contains "Invoke-SauronEye" or ScriptBlockText contains "Invoke-SCShell" or ScriptBlockText contains "Invoke-Seatbelt" or ScriptBlockText contains "Invoke-ServiceAbuse" or ScriptBlockText contains "Invoke-ShadowSpray" or ScriptBlockText contains "Invoke-Sharp" or ScriptBlockText contains "Invoke-Shellcode" or ScriptBlockText contains "Invoke-SMBScanner" or ScriptBlockText contains "Invoke-Snaffler" or ScriptBlockText contains "Invoke-Spoolsample" or ScriptBlockText contains "Invoke-SpraySinglePassword" or ScriptBlockText contains "Invoke-SSHCommand" or ScriptBlockText contains "Invoke-StandIn" or ScriptBlockText contains "Invoke-StickyNotesExtract" or ScriptBlockText contains "Invoke-SystemCommand" or ScriptBlockText contains "Invoke-Tasksbackdoor" or ScriptBlockText contains "Invoke-Tater" or ScriptBlockText contains "Invoke-Thunderfox" or ScriptBlockText contains "Invoke-ThunderStruck" or ScriptBlockText contains "Invoke-TokenManipulation" or ScriptBlockText contains "Invoke-Tokenvator" or ScriptBlockText contains "Invoke-TotalExec" or ScriptBlockText contains "Invoke-UrbanBishop" or ScriptBlockText contains "Invoke-UserHunter" or ScriptBlockText contains "Invoke-VoiceTroll" or ScriptBlockText contains "Invoke-Whisker" or ScriptBlockText contains "Invoke-WinEnum" or ScriptBlockText contains "Invoke-winPEAS" or ScriptBlockText contains "Invoke-WireTap" or ScriptBlockText contains "Invoke-WmiCommand" or ScriptBlockText contains "Invoke-WMIExec" or ScriptBlockText contains "Invoke-WScriptBypassUAC" or ScriptBlockText contains "Invoke-Zerologon" or ScriptBlockText contains "MailRaider" or ScriptBlockText contains "New-ADIDNSNode" or ScriptBlockText contains "New-HoneyHash" or ScriptBlockText contains "New-InMemoryModule" or ScriptBlockText contains "New-SOASerialNumberArray" or ScriptBlockText contains "Out-Minidump" or ScriptBlockText contains "PowerBreach" or ScriptBlockText contains "powercat " or ScriptBlockText contains "PowerUp" or ScriptBlockText contains "PowerView" or ScriptBlockText contains "Remove-ADIDNSNode" or ScriptBlockText contains "Remove-Update" or ScriptBlockText contains "Rename-ADIDNSNode" or ScriptBlockText contains "Revoke-ADIDNSPermission" or ScriptBlockText contains "Set-ADIDNSNode" or ScriptBlockText contains "Show-TargetScreen" or ScriptBlockText contains "Start-CaptureServer" or ScriptBlockText contains "Start-Dnscat2" or ScriptBlockText contains "Start-WebcamRecorder" or ScriptBlockText contains "VolumeShadowCopyTools") and (not((ScriptBlockText contains "Get-SystemDriveInfo" or ScriptBlockText contains "C:\\ProgramData\\Amazon\\EC2-Windows\\Launch\\Module\\")))
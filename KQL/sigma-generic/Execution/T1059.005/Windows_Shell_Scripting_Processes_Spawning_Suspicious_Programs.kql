// Title: Windows Shell/Scripting Processes Spawning Suspicious Programs
// Author: Florian Roth (Nextron Systems), Tim Shelton
// Date: 2018-04-06
// Level: high
// Description: Detects suspicious child processes of a Windows shell and scripting processes such as wscript, rundll32, powershell, mshta...etc.This table contains process creation events in Microsoft Sentinel. Ensure that the Windows Security Events data connector is enabled in Sentinel to have access to this table.
// Tags: attack.execution, attack.defense-evasion, attack.t1059.005, attack.t1059.001, attack.t1218
// ================================================================== 

ProcessCreationEvents
| where ((FolderPath endswith "\\schtasks.exe" or FolderPath endswith "\\nslookup.exe" or FolderPath endswith "\\certutil.exe" or FolderPath endswith "\\bitsadmin.exe" or FolderPath endswith "\\mshta.exe") and (InitiatingProcessFolderPath endswith "\\mshta.exe" or InitiatingProcessFolderPath endswith "\\powershell.exe" or InitiatingProcessFolderPath endswith "\\pwsh.exe" or InitiatingProcessFolderPath endswith "\\rundll32.exe" or InitiatingProcessFolderPath endswith "\\cscript.exe" or InitiatingProcessFolderPath endswith "\\wscript.exe" or InitiatingProcessFolderPath endswith "\\wmiprvse.exe" or InitiatingProcessFolderPath endswith "\\regsvr32.exe")) and (not(((InitiatingProcessCommandLine contains "\\Program Files\\Amazon\\WorkSpacesConfig\\Scripts\\setup-scheduledtask.ps1" or InitiatingProcessCommandLine contains "\\Program Files\\Amazon\\WorkSpacesConfig\\Scripts\\set-selfhealing.ps1" or InitiatingProcessCommandLine contains "\\Program Files\\Amazon\\WorkSpacesConfig\\Scripts\\check-workspacehealth.ps1" or InitiatingProcessCommandLine contains "\\nessus_") or CurrentDirectory contains "\\ccmcache\\" or ProcessCommandLine contains "\\nessus_" or ((ProcessCommandLine contains "C:\\MEM_Configmgr_" and ProcessCommandLine contains "\\SMSSETUP\\BIN\\" and ProcessCommandLine contains "\\autorun.hta" and ProcessCommandLine contains "{1E460BD7-F1C3-4B2E-88BF-4E770A288AF5}") and FolderPath endswith "\\mshta.exe" and (InitiatingProcessCommandLine contains "C:\\MEM_Configmgr_" and InitiatingProcessCommandLine contains "\\splash.hta" and InitiatingProcessCommandLine contains "{1E460BD7-F1C3-4B2E-88BF-4E770A288AF5}") and InitiatingProcessFolderPath endswith "\\mshta.exe"))))
// Title: Malicious PowerShell Scripts - PoshModule
// Author: frack113, Nasreddine Bencherchali (Nextron Systems)
// Date: 2023-01-23
// Level: high
// Description: Detects the execution of known offensive powershell scripts used for exploitation or reconnaissanceThis table contains security-related events from Windows machines. Make sure to have the Microsoft Security Event Log connector enabled in Sentinel to collect these events.
// Tags: attack.execution, attack.t1059.001
// ================================================================== 

SecurityEvent
| where (ContextInfo contains "Add-ConstrainedDelegationBackdoor.ps1" or ContextInfo contains "Add-Exfiltration.ps1" or ContextInfo contains "Add-Persistence.ps1" or ContextInfo contains "Add-RegBackdoor.ps1" or ContextInfo contains "Add-RemoteRegBackdoor.ps1" or ContextInfo contains "Add-ScrnSaveBackdoor.ps1" or ContextInfo contains "Check-VM.ps1" or ContextInfo contains "ConvertTo-ROT13.ps1" or ContextInfo contains "Copy-VSS.ps1" or ContextInfo contains "Create-MultipleSessions.ps1" or ContextInfo contains "DNS_TXT_Pwnage.ps1" or ContextInfo contains "dnscat2.ps1" or ContextInfo contains "Do-Exfiltration.ps1" or ContextInfo contains "DomainPasswordSpray.ps1" or ContextInfo contains "Download_Execute.ps1" or ContextInfo contains "Download-Execute-PS.ps1" or ContextInfo contains "Enabled-DuplicateToken.ps1" or ContextInfo contains "Enable-DuplicateToken.ps1" or ContextInfo contains "Execute-Command-MSSQL.ps1" or ContextInfo contains "Execute-DNSTXT-Code.ps1" or ContextInfo contains "Execute-OnTime.ps1" or ContextInfo contains "ExetoText.ps1" or ContextInfo contains "Exploit-Jboss.ps1" or ContextInfo contains "Find-AVSignature.ps1" or ContextInfo contains "Find-Fruit.ps1" or ContextInfo contains "Find-GPOLocation.ps1" or ContextInfo contains "Find-TrustedDocuments.ps1" or ContextInfo contains "FireBuster.ps1" or ContextInfo contains "FireListener.ps1" or ContextInfo contains "Get-ApplicationHost.ps1" or ContextInfo contains "Get-ChromeDump.ps1" or ContextInfo contains "Get-ClipboardContents.ps1" or ContextInfo contains "Get-ComputerDetail.ps1" or ContextInfo contains "Get-FoxDump.ps1" or ContextInfo contains "Get-GPPAutologon.ps1" or ContextInfo contains "Get-GPPPassword.ps1" or ContextInfo contains "Get-IndexedItem.ps1" or ContextInfo contains "Get-Keystrokes.ps1" or ContextInfo contains "Get-LSASecret.ps1" or ContextInfo contains "Get-MicrophoneAudio.ps1" or ContextInfo contains "Get-PassHashes.ps1" or ContextInfo contains "Get-PassHints.ps1" or ContextInfo contains "Get-RegAlwaysInstallElevated.ps1" or ContextInfo contains "Get-RegAutoLogon.ps1" or ContextInfo contains "Get-RickAstley.ps1" or ContextInfo contains "Get-Screenshot.ps1" or ContextInfo contains "Get-SecurityPackages.ps1" or ContextInfo contains "Get-ServiceFilePermission.ps1" or ContextInfo contains "Get-ServicePermission.ps1" or ContextInfo contains "Get-ServiceUnquoted.ps1" or ContextInfo contains "Get-SiteListPassword.ps1" or ContextInfo contains "Get-System.ps1" or ContextInfo contains "Get-TimedScreenshot.ps1" or ContextInfo contains "Get-UnattendedInstallFile.ps1" or ContextInfo contains "Get-Unconstrained.ps1" or ContextInfo contains "Get-USBKeystrokes.ps1" or ContextInfo contains "Get-VaultCredential.ps1" or ContextInfo contains "Get-VulnAutoRun.ps1" or ContextInfo contains "Get-VulnSchTask.ps1" or ContextInfo contains "Get-WebConfig.ps1" or ContextInfo contains "Get-WebCredentials.ps1" or ContextInfo contains "Get-WLAN-Keys.ps1" or ContextInfo contains "Gupt-Backdoor.ps1" or ContextInfo contains "HTTP-Backdoor.ps1" or ContextInfo contains "HTTP-Login.ps1" or ContextInfo contains "Install-ServiceBinary.ps1" or ContextInfo contains "Install-SSP.ps1" or ContextInfo contains "Invoke-ACLScanner.ps1" or ContextInfo contains "Invoke-ADSBackdoor.ps1" or ContextInfo contains "Invoke-AmsiBypass.ps1" or ContextInfo contains "Invoke-ARPScan.ps1" or ContextInfo contains "Invoke-BackdoorLNK.ps1" or ContextInfo contains "Invoke-BadPotato.ps1" or ContextInfo contains "Invoke-BetterSafetyKatz.ps1" or ContextInfo contains "Invoke-BruteForce.ps1" or ContextInfo contains "Invoke-BypassUAC.ps1" or ContextInfo contains "Invoke-Carbuncle.ps1" or ContextInfo contains "Invoke-Certify.ps1" or ContextInfo contains "Invoke-ConPtyShell.ps1" or ContextInfo contains "Invoke-CredentialInjection.ps1" or ContextInfo contains "Invoke-CredentialsPhish.ps1" or ContextInfo contains "Invoke-DAFT.ps1" or ContextInfo contains "Invoke-DCSync.ps1" or ContextInfo contains "Invoke-Decode.ps1" or ContextInfo contains "Invoke-DinvokeKatz.ps1" or ContextInfo contains "Invoke-DllInjection.ps1" or ContextInfo contains "Invoke-DowngradeAccount.ps1" or ContextInfo contains "Invoke-EgressCheck.ps1" or ContextInfo contains "Invoke-Encode.ps1" or ContextInfo contains "Invoke-EventViewer.ps1" or ContextInfo contains "Invoke-Eyewitness.ps1" or ContextInfo contains "Invoke-FakeLogonScreen.ps1" or ContextInfo contains "Invoke-Farmer.ps1" or ContextInfo contains "Invoke-Get-RBCD-Threaded.ps1" or ContextInfo contains "Invoke-Gopher.ps1" or ContextInfo contains "Invoke-Grouper2.ps1" or ContextInfo contains "Invoke-Grouper3.ps1" or ContextInfo contains "Invoke-HandleKatz.ps1" or ContextInfo contains "Invoke-Interceptor.ps1" or ContextInfo contains "Invoke-Internalmonologue.ps1" or ContextInfo contains "Invoke-Inveigh.ps1" or ContextInfo contains "Invoke-InveighRelay.ps1" or ContextInfo contains "Invoke-JSRatRegsvr.ps1" or ContextInfo contains "Invoke-JSRatRundll.ps1" or ContextInfo contains "Invoke-KrbRelay.ps1" or ContextInfo contains "Invoke-KrbRelayUp.ps1" or ContextInfo contains "Invoke-LdapSignCheck.ps1" or ContextInfo contains "Invoke-Lockless.ps1" or ContextInfo contains "Invoke-MalSCCM.ps1" or ContextInfo contains "Invoke-Mimikatz.ps1" or ContextInfo contains "Invoke-MimikatzWDigestDowngrade.ps1" or ContextInfo contains "Invoke-Mimikittenz.ps1" or ContextInfo contains "Invoke-MITM6.ps1" or ContextInfo contains "Invoke-NanoDump.ps1" or ContextInfo contains "Invoke-NetRipper.ps1" or ContextInfo contains "Invoke-NetworkRelay.ps1" or ContextInfo contains "Invoke-NinjaCopy.ps1" or ContextInfo contains "Invoke-OxidResolver.ps1" or ContextInfo contains "Invoke-P0wnedshell.ps1" or ContextInfo contains "Invoke-P0wnedshellx86.ps1" or ContextInfo contains "Invoke-Paranoia.ps1" or ContextInfo contains "Invoke-PortScan.ps1" or ContextInfo contains "Invoke-PoshRatHttp.ps1" or ContextInfo contains "Invoke-PoshRatHttps.ps1" or ContextInfo contains "Invoke-PostExfil.ps1" or ContextInfo contains "Invoke-PowerDump.ps1" or ContextInfo contains "Invoke-PowerShellIcmp.ps1" or ContextInfo contains "Invoke-PowerShellTCP.ps1" or ContextInfo contains "Invoke-PowerShellTcpOneLine.ps1" or ContextInfo contains "Invoke-PowerShellTcpOneLineBind.ps1" or ContextInfo contains "Invoke-PowerShellUdp.ps1" or ContextInfo contains "Invoke-PowerShellUdpOneLine.ps1" or ContextInfo contains "Invoke-PowerShellWMI.ps1" or ContextInfo contains "Invoke-PowerThIEf.ps1" or ContextInfo contains "Invoke-PPLDump.ps1" or ContextInfo contains "Invoke-Prasadhak.ps1" or ContextInfo contains "Invoke-PsExec.ps1" or ContextInfo contains "Invoke-PsGcat.ps1" or ContextInfo contains "Invoke-PsGcatAgent.ps1" or ContextInfo contains "Invoke-PSInject.ps1" or ContextInfo contains "Invoke-PsUaCme.ps1" or ContextInfo contains "Invoke-ReflectivePEInjection.ps1" or ContextInfo contains "Invoke-ReverseDNSLookup.ps1" or ContextInfo contains "Invoke-Rubeus.ps1" or ContextInfo contains "Invoke-RunAs.ps1" or ContextInfo contains "Invoke-SafetyKatz.ps1" or ContextInfo contains "Invoke-SauronEye.ps1" or ContextInfo contains "Invoke-SCShell.ps1" or ContextInfo contains "Invoke-Seatbelt.ps1" or ContextInfo contains "Invoke-ServiceAbuse.ps1" or ContextInfo contains "Invoke-SessionGopher.ps1" or ContextInfo contains "Invoke-ShellCode.ps1" or ContextInfo contains "Invoke-SMBScanner.ps1" or ContextInfo contains "Invoke-Snaffler.ps1" or ContextInfo contains "Invoke-Spoolsample.ps1" or ContextInfo contains "Invoke-SSHCommand.ps1" or ContextInfo contains "Invoke-SSIDExfil.ps1" or ContextInfo contains "Invoke-StandIn.ps1" or ContextInfo contains "Invoke-StickyNotesExtract.ps1" or ContextInfo contains "Invoke-Tater.ps1" or ContextInfo contains "Invoke-Thunderfox.ps1" or ContextInfo contains "Invoke-ThunderStruck.ps1" or ContextInfo contains "Invoke-TokenManipulation.ps1" or ContextInfo contains "Invoke-Tokenvator.ps1" or ContextInfo contains "Invoke-TotalExec.ps1" or ContextInfo contains "Invoke-UrbanBishop.ps1" or ContextInfo contains "Invoke-UserHunter.ps1" or ContextInfo contains "Invoke-VoiceTroll.ps1" or ContextInfo contains "Invoke-Whisker.ps1" or ContextInfo contains "Invoke-WinEnum.ps1" or ContextInfo contains "Invoke-winPEAS.ps1" or ContextInfo contains "Invoke-WireTap.ps1" or ContextInfo contains "Invoke-WmiCommand.ps1" or ContextInfo contains "Invoke-WScriptBypassUAC.ps1" or ContextInfo contains "Invoke-Zerologon.ps1" or ContextInfo contains "Keylogger.ps1" or ContextInfo contains "MailRaider.ps1" or ContextInfo contains "New-HoneyHash.ps1" or ContextInfo contains "OfficeMemScraper.ps1" or ContextInfo contains "Offline_Winpwn.ps1" or ContextInfo contains "Out-CHM.ps1" or ContextInfo contains "Out-DnsTxt.ps1" or ContextInfo contains "Out-Excel.ps1" or ContextInfo contains "Out-HTA.ps1" or ContextInfo contains "Out-Java.ps1" or ContextInfo contains "Out-JS.ps1" or ContextInfo contains "Out-Minidump.ps1" or ContextInfo contains "Out-RundllCommand.ps1" or ContextInfo contains "Out-SCF.ps1" or ContextInfo contains "Out-SCT.ps1" or ContextInfo contains "Out-Shortcut.ps1" or ContextInfo contains "Out-WebQuery.ps1" or ContextInfo contains "Out-Word.ps1" or ContextInfo contains "Parse_Keys.ps1" or ContextInfo contains "Port-Scan.ps1" or ContextInfo contains "PowerBreach.ps1" or ContextInfo contains "powercat.ps1" or ContextInfo contains "PowerRunAsSystem.psm1" or ContextInfo contains "PowerSharpPack.ps1" or ContextInfo contains "PowerUp.ps1" or ContextInfo contains "PowerUpSQL.ps1" or ContextInfo contains "PowerView.ps1" or ContextInfo contains "PSAsyncShell.ps1" or ContextInfo contains "RemoteHashRetrieval.ps1" or ContextInfo contains "Remove-Persistence.ps1" or ContextInfo contains "Remove-PoshRat.ps1" or ContextInfo contains "Remove-Update.ps1" or ContextInfo contains "Run-EXEonRemote.ps1" or ContextInfo contains "Schtasks-Backdoor.ps1" or ContextInfo contains "Set-DCShadowPermissions.ps1" or ContextInfo contains "Set-MacAttribute.ps1" or ContextInfo contains "Set-RemotePSRemoting.ps1" or ContextInfo contains "Set-RemoteWMI.ps1" or ContextInfo contains "Set-Wallpaper.ps1" or ContextInfo contains "Show-TargetScreen.ps1" or ContextInfo contains "Speak.ps1" or ContextInfo contains "Start-CaptureServer.ps1" or ContextInfo contains "Start-WebcamRecorder.ps1" or ContextInfo contains "StringToBase64.ps1" or ContextInfo contains "TexttoExe.ps1" or ContextInfo contains "Veeam-Get-Creds.ps1" or ContextInfo contains "VolumeShadowCopyTools.ps1" or ContextInfo contains "WinPwn.ps1" or ContextInfo contains "WSUSpendu.ps1") or (ContextInfo contains "Invoke-Sharp" and ContextInfo contains ".ps1")
// Title: Alternate PowerShell Hosts Pipe
// Author: Roberto Rodriguez @Cyb3rWard0g, Tim Shelton
// Date: 2019-09-12
// Level: medium
// Description: Detects alternate PowerShell hosts potentially bypassing detections looking for powershell.exeThis table contains Sysmon events, including Event ID 17 and Event ID 18 which are related to Named Pipe Events. To have this table present in Sentinel, you need to have Sysmon installed on your Windows endpoints and configured to log Named Pipe Events.
// Tags: attack.execution, attack.t1059.001
// ================================================================== 

SysmonEvent
| where PipeName startswith "\\PSHost" and (not(((InitiatingProcessFolderPath contains ":\\Program Files\\PowerShell\\7-preview\\pwsh.exe" or InitiatingProcessFolderPath contains ":\\Program Files\\PowerShell\\7\\pwsh.exe" or InitiatingProcessFolderPath contains ":\\Windows\\system32\\dsac.exe" or InitiatingProcessFolderPath contains ":\\Windows\\system32\\inetsrv\\w3wp.exe" or InitiatingProcessFolderPath contains ":\\Windows\\System32\\sdiagnhost.exe" or InitiatingProcessFolderPath contains ":\\Windows\\system32\\ServerManager.exe" or InitiatingProcessFolderPath contains ":\\Windows\\system32\\wbem\\wmiprvse.exe" or InitiatingProcessFolderPath contains ":\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell_ise.exe" or InitiatingProcessFolderPath contains ":\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" or InitiatingProcessFolderPath contains ":\\Windows\\System32\\wsmprovhost.exe" or InitiatingProcessFolderPath contains ":\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell_ise.exe" or InitiatingProcessFolderPath contains ":\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe") or isnull(InitiatingProcessFolderPath)))) and (not(((InitiatingProcessFolderPath endswith "\\GC\\gc_worker.exe" and InitiatingProcessFolderPath startswith "C:\\Program Files\\AzureConnectedMachineAgent\\GCArcService") or InitiatingProcessFolderPath startswith "C:\\Program Files\\Citrix\\" or InitiatingProcessFolderPath startswith "C:\\Program Files\\Microsoft\\Exchange Server\\" or (InitiatingProcessFolderPath contains "\\Microsoft SQL Server\\" and InitiatingProcessFolderPath endswith "\\Tools\\Binn\\SQLPS.exe" and (InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\" or InitiatingProcessFolderPath startswith "C:\\Program Files\\")))))
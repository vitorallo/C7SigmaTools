// Title: PowerView PowerShell Cmdlets - ScriptBlock
// Author: Bhabesh Raj
// Date: 2021-05-18
// Level: high
// Description: Detects Cmdlet names from PowerView of the PowerSploit exploitation framework.The SecurityEvent table in Microsoft Sentinel contains Windows security event logs, which may include information about PowerShell script execution. Ensure that the necessary data connectors are set up to collect Windows security event logs in Sentinel.
// Tags: attack.execution, attack.t1059.001
// ================================================================== 

SecurityEvent
| where ScriptBlockText contains "Export-PowerViewCSV" or ScriptBlockText contains "Find-DomainLocalGroupMember" or ScriptBlockText contains "Find-DomainObjectPropertyOutlier" or ScriptBlockText contains "Find-DomainProcess" or ScriptBlockText contains "Find-DomainShare" or ScriptBlockText contains "Find-DomainUserEvent" or ScriptBlockText contains "Find-DomainUserLocation" or ScriptBlockText contains "Find-ForeignGroup" or ScriptBlockText contains "Find-ForeignUser" or ScriptBlockText contains "Find-GPOComputerAdmin" or ScriptBlockText contains "Find-GPOLocation" or ScriptBlockText contains "Find-InterestingDomain" or ScriptBlockText contains "Find-InterestingFile" or ScriptBlockText contains "Find-LocalAdminAccess" or ScriptBlockText contains "Find-ManagedSecurityGroups" or ScriptBlockText contains "Get-CachedRDPConnection" or ScriptBlockText contains "Get-DFSshare" or ScriptBlockText contains "Get-DomainDFSShare" or ScriptBlockText contains "Get-DomainDNSRecord" or ScriptBlockText contains "Get-DomainDNSZone" or ScriptBlockText contains "Get-DomainFileServer" or ScriptBlockText contains "Get-DomainGPOComputerLocalGroupMapping" or ScriptBlockText contains "Get-DomainGPOLocalGroup" or ScriptBlockText contains "Get-DomainGPOUserLocalGroupMapping" or ScriptBlockText contains "Get-LastLoggedOn" or ScriptBlockText contains "Get-LoggedOnLocal" or ScriptBlockText contains "Get-NetFileServer" or ScriptBlockText contains "Get-NetForest" or ScriptBlockText contains "Get-NetGPOGroup" or ScriptBlockText contains "Get-NetProcess" or ScriptBlockText contains "Get-NetRDPSession" or ScriptBlockText contains "Get-RegistryMountedDrive" or ScriptBlockText contains "Get-RegLoggedOn" or ScriptBlockText contains "Get-WMIRegCachedRDPConnection" or ScriptBlockText contains "Get-WMIRegLastLoggedOn" or ScriptBlockText contains "Get-WMIRegMountedDrive" or ScriptBlockText contains "Get-WMIRegProxy" or ScriptBlockText contains "Invoke-ACLScanner" or ScriptBlockText contains "Invoke-CheckLocalAdminAccess" or ScriptBlockText contains "Invoke-EnumerateLocalAdmin" or ScriptBlockText contains "Invoke-EventHunter" or ScriptBlockText contains "Invoke-FileFinder" or ScriptBlockText contains "Invoke-Kerberoast" or ScriptBlockText contains "Invoke-MapDomainTrust" or ScriptBlockText contains "Invoke-ProcessHunter" or ScriptBlockText contains "Invoke-RevertToSelf" or ScriptBlockText contains "Invoke-ShareFinder" or ScriptBlockText contains "Invoke-UserHunter" or ScriptBlockText contains "Invoke-UserImpersonation" or ScriptBlockText contains "Remove-RemoteConnection" or ScriptBlockText contains "Request-SPNTicket" or ScriptBlockText contains "Resolve-IPAddress"
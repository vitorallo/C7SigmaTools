// Title: Malicious Nishang PowerShell Commandlets
// Author: Alec Costello
// Date: 2019-05-16
// Level: high
// Description: Detects Commandlet names and arguments from the Nishang exploitation frameworkThis table contains Windows security event logs, including PowerShell script block logs. Make sure to enable the necessary data connectors in Sentinel to collect Windows security event logs.
// Tags: attack.execution, attack.t1059.001
// ================================================================== 

SecurityEvent
| where ScriptBlockText contains "Add-ConstrainedDelegationBackdoor" or ScriptBlockText contains "Copy-VSS" or ScriptBlockText contains "Create-MultipleSessions" or ScriptBlockText contains "DataToEncode" or ScriptBlockText contains "DNS_TXT_Pwnage" or ScriptBlockText contains "Do-Exfiltration-Dns" or ScriptBlockText contains "Download_Execute" or ScriptBlockText contains "Download-Execute-PS" or ScriptBlockText contains "DownloadAndExtractFromRemoteRegistry" or ScriptBlockText contains "DumpCerts" or ScriptBlockText contains "DumpCreds" or ScriptBlockText contains "DumpHashes" or ScriptBlockText contains "Enable-DuplicateToken" or ScriptBlockText contains "Enable-Duplication" or ScriptBlockText contains "Execute-Command-MSSQL" or ScriptBlockText contains "Execute-DNSTXT-Code" or ScriptBlockText contains "Execute-OnTime" or ScriptBlockText contains "ExetoText" or ScriptBlockText contains "exfill" or ScriptBlockText contains "ExfilOption" or ScriptBlockText contains "FakeDC" or ScriptBlockText contains "FireBuster" or ScriptBlockText contains "FireListener" or ScriptBlockText contains "Get-Information " or ScriptBlockText contains "Get-PassHints" or ScriptBlockText contains "Get-Web-Credentials" or ScriptBlockText contains "Get-WebCredentials" or ScriptBlockText contains "Get-WLAN-Keys" or ScriptBlockText contains "HTTP-Backdoor" or ScriptBlockText contains "Invoke-AmsiBypass" or ScriptBlockText contains "Invoke-BruteForce" or ScriptBlockText contains "Invoke-CredentialsPhish" or ScriptBlockText contains "Invoke-Decode" or ScriptBlockText contains "Invoke-Encode" or ScriptBlockText contains "Invoke-Interceptor" or ScriptBlockText contains "Invoke-JSRatRegsvr" or ScriptBlockText contains "Invoke-JSRatRundll" or ScriptBlockText contains "Invoke-MimikatzWDigestDowngrade" or ScriptBlockText contains "Invoke-NetworkRelay" or ScriptBlockText contains "Invoke-PowerShellIcmp" or ScriptBlockText contains "Invoke-PowerShellUdp" or ScriptBlockText contains "Invoke-Prasadhak" or ScriptBlockText contains "Invoke-PSGcat" or ScriptBlockText contains "Invoke-PsGcatAgent" or ScriptBlockText contains "Invoke-SessionGopher" or ScriptBlockText contains "Invoke-SSIDExfil" or ScriptBlockText contains "LoggedKeys" or ScriptBlockText contains "Nishang" or ScriptBlockText contains "NotAllNameSpaces" or ScriptBlockText contains "Out-CHM" or ScriptBlockText contains "OUT-DNSTXT" or ScriptBlockText contains "Out-HTA" or ScriptBlockText contains "Out-RundllCommand" or ScriptBlockText contains "Out-SCF" or ScriptBlockText contains "Out-SCT" or ScriptBlockText contains "Out-Shortcut" or ScriptBlockText contains "Out-WebQuery" or ScriptBlockText contains "Out-Word" or ScriptBlockText contains "Parse_Keys" or ScriptBlockText contains "Password-List" or ScriptBlockText contains "Powerpreter" or ScriptBlockText contains "Remove-Persistence" or ScriptBlockText contains "Remove-PoshRat" or ScriptBlockText contains "Remove-Update" or ScriptBlockText contains "Run-EXEonRemote" or ScriptBlockText contains "Set-DCShadowPermissions" or ScriptBlockText contains "Set-RemotePSRemoting" or ScriptBlockText contains "Set-RemoteWMI" or ScriptBlockText contains "Shellcode32" or ScriptBlockText contains "Shellcode64" or ScriptBlockText contains "StringtoBase64" or ScriptBlockText contains "TexttoExe"
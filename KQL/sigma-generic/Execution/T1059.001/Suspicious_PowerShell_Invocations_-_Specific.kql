// Title: Suspicious PowerShell Invocations - Specific
// Author: Florian Roth (Nextron Systems), Jonhnathan Ribeiro
// Date: 2017-03-05
// Level: high
// Description: Detects suspicious PowerShell invocation command parametersThe SecurityEvent table in Microsoft Sentinel contains Windows security event logs, which would include logs related to PowerShell script execution. Ensure that the Windows Security Events connector is enabled in Microsoft Sentinel to collect these logs.
// Tags: attack.execution, attack.t1059.001
// ================================================================== 

SecurityEvent
| where ((ScriptBlockText contains "-nop" and ScriptBlockText contains " -w " and ScriptBlockText contains "hidden" and ScriptBlockText contains " -c " and ScriptBlockText contains "[Convert]::FromBase64String") or (ScriptBlockText contains " -w " and ScriptBlockText contains "hidden" and ScriptBlockText contains "-ep" and ScriptBlockText contains "bypass" and ScriptBlockText contains "-Enc") or (ScriptBlockText contains " -w " and ScriptBlockText contains "hidden" and ScriptBlockText contains "-noni" and ScriptBlockText contains "-nop" and ScriptBlockText contains " -c " and ScriptBlockText contains "iex" and ScriptBlockText contains "New-Object") or (ScriptBlockText contains "iex" and ScriptBlockText contains "New-Object" and ScriptBlockText contains "Net.WebClient" and ScriptBlockText contains ".Download") or (ScriptBlockText contains "powershell" and ScriptBlockText contains "reg" and ScriptBlockText contains "add" and ScriptBlockText contains "HKCU\\software\\microsoft\\windows\\currentversion\\run") or (ScriptBlockText contains "bypass" and ScriptBlockText contains "-noprofile" and ScriptBlockText contains "-windowstyle" and ScriptBlockText contains "hidden" and ScriptBlockText contains "new-object" and ScriptBlockText contains "system.net.webclient" and ScriptBlockText contains ".download")) and (not((ScriptBlockText contains "(New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1" or ScriptBlockText contains "(New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')" or ScriptBlockText contains "Write-ChocolateyWarning")))
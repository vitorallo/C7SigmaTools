// Title: Potential Direct Syscall of NtOpenProcess
// Author: Christian Burkard (Nextron Systems), Tim Shelton (FP)
// Date: 2021-07-28
// Level: medium
// Description: Detects potential calls to NtOpenProcess directly from NTDLL.The ProcessCreationEvents table in Microsoft Sentinel contains information about process creation events on Windows machines. To query this table, ensure that you have the necessary connectors or data sources configured in Sentinel to collect process access logs from Windows machines.
// Tags: attack.execution, attack.t1106
// ================================================================== 

ProcessCreationEvents
| where CallTrace startswith "UNKNOWN" and (not((((InitiatingProcessFolderPath contains ":\\Program Files (x86)\\" or InitiatingProcessFolderPath contains ":\\Program Files\\" or InitiatingProcessFolderPath contains ":\\Windows\\System32\\" or InitiatingProcessFolderPath contains ":\\Windows\\SysWOW64\\" or InitiatingProcessFolderPath contains ":\\Windows\\WinSxS\\") and (TargetImage contains ":\\Program Files (x86)\\" or TargetImage contains ":\\Program Files\\" or TargetImage contains ":\\Windows\\System32\\" or TargetImage contains ":\\Windows\\SysWOW64\\" or TargetImage contains ":\\Windows\\WinSxS\\")) or Provider_Name =~ "Microsoft-Windows-Kernel-Audit-API-Calls" or (InitiatingProcessFolderPath endswith "vcredist_x64.exe" and TargetImage endswith "vcredist_x64.exe")))) and (not(((InitiatingProcessFolderPath contains ":\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\" and InitiatingProcessFolderPath endswith "\\AcroCEF.exe" and TargetImage contains ":\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\" and TargetImage endswith "\\AcroCEF.exe") or (InitiatingProcessFolderPath endswith "AmazonSSMAgentSetup.exe" and TargetImage endswith "AmazonSSMAgentSetup.exe") or (InitiatingProcessFolderPath endswith ":\\Windows\\Explorer.EXE" and TargetImage endswith ":\\Program Files\\Cylance\\Desktop\\CylanceUI.exe") or (TargetImage contains "\\AppData\\Local\\Discord\\" and TargetImage endswith "\\Discord.exe") or TargetImage endswith "\\Evernote\\Evernote.exe" or (InitiatingProcessFolderPath endswith "\\AppData\\Local\\Microsoft\\Teams\\current\\Teams.exe" and TargetImage endswith "\\AppData\\Local\\Microsoft\\Teams\\current\\Teams.exe") or (InitiatingProcessFolderPath endswith "setup64.exe" and TargetImage endswith ":\\Windows\\system32\\systeminfo.exe") or (InitiatingProcessFolderPath endswith "\\AppData\\Local\\Programs\\Microsoft VS Code\\Code.exe" and TargetImage endswith "\\AppData\\Local\\Programs\\Microsoft VS Code\\Code.exe") or (GrantedAccess =~ "0x1000" and InitiatingProcessFolderPath contains "\\AppData\\Local\\yammerdesktop\\app-" and InitiatingProcessFolderPath endswith "\\Yammer.exe" and TargetImage contains "\\AppData\\Local\\yammerdesktop\\app-" and TargetImage endswith "\\Yammer.exe"))))
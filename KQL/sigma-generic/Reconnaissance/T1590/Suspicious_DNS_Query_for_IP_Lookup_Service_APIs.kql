// Title: Suspicious DNS Query for IP Lookup Service APIs
// Author: Brandon George (blog post), Thomas Patzke
// Date: 2021-07-08
// Level: medium
// Description: Detects DNS queries for IP lookup services such as "api.ipify.org" originating from a non browser process.The DnsEvents table in Microsoft Sentinel contains DNS query logs. Ensure that the Windows Security Events data connector is enabled in Sentinel to have access to this table.
// Tags: attack.reconnaissance, attack.t1590
// ================================================================== 

DnsEvents
| where ((QueryName in~ ("www.ip.cn", "l2.io")) or (QueryName contains "api.2ip.ua" or QueryName contains "api.bigdatacloud.net" or QueryName contains "api.ipify.org" or QueryName contains "bot.whatismyipaddress.com" or QueryName contains "canireachthe.net" or QueryName contains "checkip.amazonaws.com" or QueryName contains "checkip.dyndns.org" or QueryName contains "curlmyip.com" or QueryName contains "db-ip.com" or QueryName contains "edns.ip-api.com" or QueryName contains "eth0.me" or QueryName contains "freegeoip.app" or QueryName contains "geoipy.com" or QueryName contains "getip.pro" or QueryName contains "icanhazip.com" or QueryName contains "ident.me" or QueryName contains "ifconfig.io" or QueryName contains "ifconfig.me" or QueryName contains "ip-api.com" or QueryName contains "ip.360.cn" or QueryName contains "ip.anysrc.net" or QueryName contains "ip.taobao.com" or QueryName contains "ip.tyk.nu" or QueryName contains "ipaddressworld.com" or QueryName contains "ipapi.co" or QueryName contains "ipconfig.io" or QueryName contains "ipecho.net" or QueryName contains "ipinfo.io" or QueryName contains "ipip.net" or QueryName contains "ipof.in" or QueryName contains "ipv4.icanhazip.com" or QueryName contains "ipv4bot.whatismyipaddress.com" or QueryName contains "ipv6-test.com" or QueryName contains "ipwho.is" or QueryName contains "jsonip.com" or QueryName contains "myexternalip.com" or QueryName contains "seeip.org" or QueryName contains "wgetip.com" or QueryName contains "whatismyip.akamai.com" or QueryName contains "whois.pconline.com.cn" or QueryName contains "wtfismyip.com")) and (not((InitiatingProcessFolderPath endswith "\\brave.exe" or (InitiatingProcessFolderPath in~ ("C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe", "C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe")) or (InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\" or InitiatingProcessFolderPath endswith "\\WindowsApps\\MicrosoftEdge.exe" or (InitiatingProcessFolderPath in~ ("C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe", "C:\\Program Files\\Microsoft\\Edge\\Application\\msedge.exe"))) or ((InitiatingProcessFolderPath endswith "\\msedge.exe" or InitiatingProcessFolderPath endswith "\\msedgewebview2.exe") and (InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\Microsoft\\EdgeCore\\" or InitiatingProcessFolderPath startswith "C:\\Program Files\\Microsoft\\EdgeCore\\")) or (InitiatingProcessFolderPath in~ ("C:\\Program Files\\Mozilla Firefox\\firefox.exe", "C:\\Program Files (x86)\\Mozilla Firefox\\firefox.exe")) or (InitiatingProcessFolderPath in~ ("C:\\Program Files (x86)\\Internet Explorer\\iexplore.exe", "C:\\Program Files\\Internet Explorer\\iexplore.exe")) or InitiatingProcessFolderPath endswith "\\maxthon.exe" or InitiatingProcessFolderPath endswith "\\opera.exe" or InitiatingProcessFolderPath endswith "\\safari.exe" or InitiatingProcessFolderPath endswith "\\seamonkey.exe" or InitiatingProcessFolderPath endswith "\\vivaldi.exe" or InitiatingProcessFolderPath endswith "\\whale.exe")))
// Title: Potential Active Directory Reconnaissance/Enumeration Via LDAP
// Author: Adeem Mawani
// Date: 2021-06-22
// Level: medium
// Description: Detects potential Active Directory enumeration via LDAPThe Event table in Microsoft Sentinel contains logs from various sources, including Windows events. To query LDAP logs, you may need to enable the collection of Windows Security Event logs in Sentinel.
// Tags: attack.discovery, attack.t1069.002, attack.t1087.002, attack.t1482
// ================================================================== 

Event
| where ((SearchFilter contains "(groupType:1.2.840.113556.1.4.803:=2147483648)" or SearchFilter contains "(groupType:1.2.840.113556.1.4.803:=2147483656)" or SearchFilter contains "(groupType:1.2.840.113556.1.4.803:=2147483652)" or SearchFilter contains "(groupType:1.2.840.113556.1.4.803:=2147483650)" or SearchFilter contains "(sAMAccountType=805306369)" or SearchFilter contains "(sAMAccountType=805306368)" or SearchFilter contains "(sAMAccountType=536870913)" or SearchFilter contains "(sAMAccountType=536870912)" or SearchFilter contains "(sAMAccountType=268435457)" or SearchFilter contains "(sAMAccountType=268435456)" or SearchFilter contains "(objectCategory=groupPolicyContainer)" or SearchFilter contains "(objectCategory=organizationalUnit)" or SearchFilter contains "(objectCategory=Computer)" or SearchFilter contains "(objectCategory=nTDSDSA)" or SearchFilter contains "(objectCategory=server)" or SearchFilter contains "(objectCategory=domain)" or SearchFilter contains "(objectCategory=person)" or SearchFilter contains "(objectCategory=group)" or SearchFilter contains "(objectCategory=user)" or SearchFilter contains "(objectClass=trustedDomain)" or SearchFilter contains "(objectClass=computer)" or SearchFilter contains "(objectClass=server)" or SearchFilter contains "(objectClass=group)" or SearchFilter contains "(objectClass=user)" or SearchFilter contains "(primaryGroupID=521)" or SearchFilter contains "(primaryGroupID=516)" or SearchFilter contains "(primaryGroupID=515)" or SearchFilter contains "(primaryGroupID=512)" or SearchFilter contains "Domain Admins" or SearchFilter contains "objectGUID=*" or SearchFilter contains "(schemaIDGUID=*)" or SearchFilter contains "admincount=1") and (not(((SearchFilter contains "(domainSid=" and SearchFilter contains ")") or (SearchFilter contains "(objectSid=" and SearchFilter contains ")"))))) or (SearchFilter contains "(userAccountControl:1.2.840.113556.1.4.803:=4194304)" or SearchFilter contains "(userAccountControl:1.2.840.113556.1.4.803:=2097152)" or SearchFilter contains "!(userAccountControl:1.2.840.113556.1.4.803:=1048574)" or SearchFilter contains "(userAccountControl:1.2.840.113556.1.4.803:=524288)" or SearchFilter contains "(userAccountControl:1.2.840.113556.1.4.803:=65536)" or SearchFilter contains "(userAccountControl:1.2.840.113556.1.4.803:=8192)" or SearchFilter contains "(userAccountControl:1.2.840.113556.1.4.803:=544)" or SearchFilter contains "!(UserAccountControl:1.2.840.113556.1.4.803:=2)" or SearchFilter contains "msDS-AllowedToActOnBehalfOfOtherIdentity" or SearchFilter contains "msDS-AllowedToDelegateTo" or SearchFilter contains "msDS-GroupManagedServiceAccount" or SearchFilter contains "(accountExpires=9223372036854775807)" or SearchFilter contains "(accountExpires=0)" or SearchFilter contains "(adminCount=1)" or SearchFilter contains "ms-MCS-AdmPwd") or ((DistinguishedName contains "CN=Domain Admins" or DistinguishedName contains "CN=Enterprise Admins" or DistinguishedName contains "CN=Group Policy Creator Owners") and SearchFilter =~ "(objectclass=*)")
// Title: DirectorySearcher Powershell Exploitation
// Author: frack113
// Date: 2022-02-12
// Level: medium
// Description: Enumerates Active Directory to determine computers that are joined to the domainThe SecurityEvent table in Microsoft Sentinel contains Windows security event logs, which would include logs related to PowerShell script execution. Make sure to have the necessary connectors and data sources configured in Sentinel to collect Windows security event logs.
// Tags: attack.discovery, attack.t1018
// ================================================================== 

SecurityEvent
| where ScriptBlockText contains "New-Object " and ScriptBlockText contains "System.DirectoryServices.DirectorySearcher" and ScriptBlockText contains ".PropertiesToLoad.Add" and ScriptBlockText contains ".findall()" and ScriptBlockText contains "Properties.name"
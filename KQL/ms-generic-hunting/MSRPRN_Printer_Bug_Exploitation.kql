// Description: 'This query detects potential attempts to remotely access to the print spooler service on Active Directory Domain Controllers which could indicate an exploitation of MS-RPRN printer bug from a server that is configured with unconstrained delegation.'
// Required Connectors: SecurityEvents (Types: SecurityEvent); WindowsSecurityEvents (Types: SecurityEvent)

// Enter a reference list of hostnames for your DC servers
// let DCServersList = dynamic (["DC01.domain.local","DC02.domain.local"]);
// Enter a reference list of IP addresses for your unconstrained delegation servers
// let UnconstrainedServersIPList = dynamic (["10.1.0.7","10.1.0.45"]);
SecurityEvent
// | where Computer in (DCServersList)
// | where IpAddress  in (UnconstrainedServersIPList)
| where EventID == 5145 and ShareName == "\\\\*\\IPC$" and RelativeTargetName == "spoolss"
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by Computer, SubjectUserName, IpAddress, ShareName, RelativeTargetName, Type, SubjectUserSid
| extend HostName = tostring(split(Computer, '.', 0)[0]), DnsDomain = tostring(strcat_array(array_slice(split(Computer, '.'), 1, -1), '.'))
| extend Account_0_Name = SubjectUserName
| extend Host_0_HostName = HostName
| extend Host_0_DnsDomain = DnsDomain
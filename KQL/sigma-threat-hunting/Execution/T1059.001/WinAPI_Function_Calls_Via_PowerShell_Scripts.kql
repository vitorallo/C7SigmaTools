// Title: WinAPI Function Calls Via PowerShell Scripts
// Author: Nikita Nazarov, oscd.community, Nasreddine Bencherchali (Nextron Systems)
// Date: 2023-07-21
// Level: medium
// Description: Detects calls to WinAPI functions from PowerShell scripts. Attackers can often leverage these APIs to avoid detection based on typical PowerShell function calls. Use this rule as a basis to hunt for interesting scripts.The SecurityEvent table in Microsoft Sentinel contains logs related to security events on Windows machines. To query for Script Block Logging events, ensure that the Microsoft Monitoring Agent (MMA) is installed on the Windows machines and configured to send security event logs to Sentinel.
// Tags: attack.execution, attack.t1059.001, attack.t1106, detection.threat-hunting
// ================================================================== 

SecurityEvent
| where ScriptBlockText contains "AddSecurityPackage" or ScriptBlockText contains "AdjustTokenPrivileges" or ScriptBlockText contains "CloseHandle" or ScriptBlockText contains "CreateProcessWithToken" or ScriptBlockText contains "CreateRemoteThread" or ScriptBlockText contains "CreateThread" or ScriptBlockText contains "CreateUserThread" or ScriptBlockText contains "DangerousGetHandle" or ScriptBlockText contains "DuplicateTokenEx" or ScriptBlockText contains "EnumerateSecurityPackages" or ScriptBlockText contains "FreeLibrary" or ScriptBlockText contains "GetDelegateForFunctionPointer" or ScriptBlockText contains "GetLogonSessionData" or ScriptBlockText contains "GetModuleHandle" or ScriptBlockText contains "GetProcAddress" or ScriptBlockText contains "GetProcessHandle" or ScriptBlockText contains "GetTokenInformation" or ScriptBlockText contains "ImpersonateLoggedOnUser" or ScriptBlockText contains "LoadLibrary" or ScriptBlockText contains "memcpy" or ScriptBlockText contains "MiniDumpWriteDump" or ScriptBlockText contains "OpenDesktop" or ScriptBlockText contains "OpenProcess" or ScriptBlockText contains "OpenProcessToken" or ScriptBlockText contains "OpenThreadToken" or ScriptBlockText contains "OpenWindowStation" or ScriptBlockText contains "QueueUserApc" or ScriptBlockText contains "ReadProcessMemory" or ScriptBlockText contains "RevertToSelf" or ScriptBlockText contains "RtlCreateUserThread" or ScriptBlockText contains "SetThreadToken" or ScriptBlockText contains "VirtualAlloc" or ScriptBlockText contains "VirtualFree" or ScriptBlockText contains "VirtualProtect" or ScriptBlockText contains "WaitForSingleObject" or ScriptBlockText contains "WriteInt32" or ScriptBlockText contains "WriteProcessMemory" or ScriptBlockText contains "ZeroFreeGlobalAllocUnicode"
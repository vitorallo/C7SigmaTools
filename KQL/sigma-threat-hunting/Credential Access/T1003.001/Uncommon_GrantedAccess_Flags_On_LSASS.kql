// Title: Uncommon GrantedAccess Flags On LSASS
// Author: Florian Roth (Nextron Systems)
// Date: 2022-03-13
// Level: medium
// Description: Detects process access to LSASS memory with uncommon access flags 0x410 and 0x01410This table contains information about process creation events in Windows. To have this table present in Microsoft Sentinel, ensure that you have the necessary data connectors set up to collect process access logs from Windows machines.
// Tags: attack.credential-access, attack.t1003.001, attack.s0002, detection.threat-hunting
// ================================================================== 

ProcessCreationEvents
| where (GrantedAccess endswith "10" and TargetImage endswith "\\lsass.exe") and (not(((InitiatingProcessFolderPath in~ ("C:\\Program Files\\Common Files\\McAfee\\MMSSHost\\MMSSHOST.exe", "C:\\Program Files\\Malwarebytes\\Anti-Malware\\MBAMService.exe", "C:\\Program Files\\Windows Defender\\MsMpEng.exe", "C:\\PROGRAMDATA\\MALWAREBYTES\\MBAMSERVICE\\ctlrupdate\\mbupdatr.exe", "C:\\Windows\\System32\\lsass.exe", "C:\\Windows\\System32\\msiexec.exe", "C:\\WINDOWS\\System32\\perfmon.exe", "C:\\WINDOWS\\system32\\taskhostw.exe", "C:\\WINDOWS\\system32\\taskmgr.exe", "C:\\WINDOWS\\system32\\wbem\\wmiprvse.exe", "C:\\Windows\\SysWOW64\\msiexec.exe", "C:\\Windows\\sysWOW64\\wbem\\wmiprvse.exe")) or (InitiatingProcessFolderPath endswith "\\MsMpEng.exe" and InitiatingProcessFolderPath startswith "C:\\ProgramData\\Microsoft\\Windows Defender\\") or (InitiatingProcessFolderPath endswith "\\GamingServices.exe" and InitiatingProcessFolderPath startswith "C:\\Program Files\\WindowsApps\\") or (InitiatingProcessFolderPath endswith "\\PROCEXP64.EXE" or InitiatingProcessFolderPath endswith "\\PROCEXP.EXE") or (InitiatingProcessFolderPath endswith "\\vmtoolsd.exe" and InitiatingProcessFolderPath startswith "C:\\ProgramData\\VMware\\VMware Tools\\") or (InitiatingProcessFolderPath contains "Antivirus" and (InitiatingProcessFolderPath startswith "C:\\Program Files\\" or InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\")) or ((GrantedAccess in~ ("0x410", "0x10")) and InitiatingProcessFolderPath contains "\\SteamLibrary\\steamapps\\") or (InitiatingProcessFolderPath startswith "C:\\Program Files\\" or InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\" or InitiatingProcessFolderPath startswith "C:\\WINDOWS\\system32\\") or ((InitiatingProcessFolderPath contains "C:\\Users\\" and InitiatingProcessFolderPath contains "\\AppData\\Local\\") and (InitiatingProcessFolderPath endswith "\\Microsoft VS Code\\Code.exe" or InitiatingProcessFolderPath endswith "\\software_reporter_tool.exe" or InitiatingProcessFolderPath endswith "\\DropboxUpdate.exe" or InitiatingProcessFolderPath endswith "\\MBAMInstallerService.exe" or InitiatingProcessFolderPath endswith "\\WebEx\\WebexHost.exe" or InitiatingProcessFolderPath endswith "\\Programs\\Microsoft VS Code\\Code.exe" or InitiatingProcessFolderPath endswith "\\JetBrains\\Toolbox\\bin\\jetbrains-toolbox.exe")) or (GrantedAccess =~ "0x1410" and (InitiatingProcessFolderPath contains "\\AppData\\Local\\Temp\\" and InitiatingProcessFolderPath contains "\\vs_bootstrapper_")) or (InitiatingProcessFolderPath endswith "\\thor64.exe" or InitiatingProcessFolderPath endswith "\\thor.exe" or InitiatingProcessFolderPath endswith "\\aurora-agent-64.exe" or InitiatingProcessFolderPath endswith "\\aurora-agent.exe") or SourceCommandLine =~ "C:\\WINDOWS\\system32\\wermgr.exe -upload" or (GrantedAccess =~ "0x410" and InitiatingProcessFolderPath endswith "\\xampp-control.exe"))))
// Title: LSASS Access From Program In Potentially Suspicious Folder
// Author: Florian Roth (Nextron Systems)
// Date: 2021-11-27
// Level: medium
// Description: Detects process access to LSASS memory with suspicious access flags and from a potentially suspicious folderThe SecurityEvent table in Microsoft Sentinel contains Windows security event logs. Ensure that the Windows Security events data connector is enabled in Sentinel to have access to this table.
// Tags: attack.credential-access, attack.t1003.001, attack.s0002
// ================================================================== 

SecurityEvent
| where ((GrantedAccess endswith "10" or GrantedAccess endswith "30" or GrantedAccess endswith "50" or GrantedAccess endswith "70" or GrantedAccess endswith "90" or GrantedAccess endswith "B0" or GrantedAccess endswith "D0" or GrantedAccess endswith "F0" or GrantedAccess endswith "18" or GrantedAccess endswith "38" or GrantedAccess endswith "58" or GrantedAccess endswith "78" or GrantedAccess endswith "98" or GrantedAccess endswith "B8" or GrantedAccess endswith "D8" or GrantedAccess endswith "F8" or GrantedAccess endswith "1A" or GrantedAccess endswith "3A" or GrantedAccess endswith "5A" or GrantedAccess endswith "7A" or GrantedAccess endswith "9A" or GrantedAccess endswith "BA" or GrantedAccess endswith "DA" or GrantedAccess endswith "FA" or GrantedAccess endswith "0x14C2" or GrantedAccess endswith "FF") and (InitiatingProcessFolderPath contains "\\Temp\\" or InitiatingProcessFolderPath contains "\\Users\\Public\\" or InitiatingProcessFolderPath contains "\\PerfLogs\\" or InitiatingProcessFolderPath contains "\\AppData\\" or InitiatingProcessFolderPath contains "\\Temporary") and TargetImage endswith "\\lsass.exe") and (not(((GrantedAccess =~ "0x1410" and (InitiatingProcessFolderPath contains ":\\Program Files\\Common Files\\Adobe\\ARM\\" or InitiatingProcessFolderPath contains ":\\Program Files (x86)\\Common Files\\Adobe\\ARM\\") and InitiatingProcessFolderPath endswith "\\AdobeARMHelper.exe") or (GrantedAccess =~ "0x1410" and InitiatingProcessFolderPath contains "\\AppData\\Local\\Temp\\is-" and InitiatingProcessFolderPath endswith ".tmp\\avira_system_speedup.tmp") or ((GrantedAccess in~ ("0x410", "0x1410")) and InitiatingProcessFolderPath contains ":\\Program Files (x86)\\Google\\Temp\\" and InitiatingProcessFolderPath endswith ".tmp\\GoogleUpdate.exe") or ((GrantedAccess in~ ("0x410", "0x1410")) and InitiatingProcessFolderPath contains ":\\Windows\\Temp\\" and InitiatingProcessFolderPath endswith ".tmp\\DropboxUpdate.exe") or (GrantedAccess =~ "0x1410" and (InitiatingProcessFolderPath contains ":\\Users\\" and InitiatingProcessFolderPath contains "\\AppData\\Local\\Temp\\") and InitiatingProcessFolderPath endswith ".tmp\\DropboxUpdate.exe") or (GrantedAccess =~ "0x1410" and (InitiatingProcessFolderPath contains ":\\Program Files (x86)\\Dropbox\\" or InitiatingProcessFolderPath contains ":\\Program Files\\Dropbox\\") and InitiatingProcessFolderPath endswith "\\DropboxUpdate.exe") or (GrantedAccess =~ "0x410" and (InitiatingProcessFolderPath contains ":\\Users\\" and InitiatingProcessFolderPath contains "\\AppData\\Local\\") and (InitiatingProcessFolderPath endswith "\\Microsoft VS Code\\Code.exe" or InitiatingProcessFolderPath endswith "\\software_reporter_tool.exe" or InitiatingProcessFolderPath endswith "\\DropboxUpdate.exe" or InitiatingProcessFolderPath endswith "\\MBAMInstallerService.exe" or InitiatingProcessFolderPath endswith "\\WebexMTA.exe" or InitiatingProcessFolderPath endswith "\\Meetings\\WebexMTAV2.exe" or InitiatingProcessFolderPath endswith "\\WebEx\\WebexHost.exe" or InitiatingProcessFolderPath endswith "\\JetBrains\\Toolbox\\bin\\jetbrains-toolbox.exe")) or (GrantedAccess =~ "0x1fffff" and InitiatingProcessFolderPath contains ":\\Users\\" and InitiatingProcessFolderPath endswith "\\AppData\\Local\\Keybase\\keybase.exe") or (GrantedAccess =~ "0x1410" and (InitiatingProcessFolderPath contains ":\\Users\\" and InitiatingProcessFolderPath contains "\\AppData\\Local\\Temp\\" and InitiatingProcessFolderPath contains "\\vs_bootstrapper_")) or ((GrantedAccess in~ ("0x1fffff", "0x1010", "0x101010")) and (InitiatingProcessFolderPath contains ":\\Windows\\Temp\\asgard2-agent\\" or InitiatingProcessFolderPath contains ":\\Windows\\Temp\\asgard2-agent-sc\\") and (InitiatingProcessFolderPath endswith "\\thor64.exe" or InitiatingProcessFolderPath endswith "\\thor.exe" or InitiatingProcessFolderPath endswith "\\aurora-agent-64.exe" or InitiatingProcessFolderPath endswith "\\aurora-agent.exe")) or (GrantedAccess =~ "0x1fffff" and InitiatingProcessFolderPath contains "\\AppData\\Roaming\\ViberPC\\" and InitiatingProcessFolderPath endswith "\\updater.exe" and TargetImage endswith "\\winlogon.exe"))))
// Description: This query detects possible abuse of ms-msdt MSProtocol URI scheme to load and execute malicious code via Microsoft Support Diagnostic Tool Vulnerability (CVE-2022-30190).
// The following query detects when Microsoft Office software spawns an instance of the MSDT utility, msdt.exe.
// References:
// https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190
// https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/
// https://www.huntress.com/blog/microsoft-office-remote-code-execution-follina-msdt-bug
// https://attack.mitre.org/techniques/T1221/
// Required Connectors: MicrosoftThreatProtection (Types: DeviceProcessEvents)

// Office products spawning MSDT
DeviceProcessEvents
| where InitiatingProcessFileName in~ ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe")
and FileName =~"msdt.exe"
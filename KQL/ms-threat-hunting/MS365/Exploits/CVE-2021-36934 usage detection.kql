// Description: Assuming that you have a machine that is properly BitLocker'ed, then
// the machine will need to be running to extract the SAM and SYSTEM
// files.
// This first query looks for any access to the HKLM that happens via a command
// or script that is not executed by system.
// The second query looks for usage of reg or regedit by anyone who is not system.
// Required Connectors: MicrosoftThreatProtection (Types: DeviceProcessEvents)

let startTime = now(-7d);
let endTime = now();
DeviceProcessEvents
| where Timestamp between (startTime..endTime)
| where ProcessCommandLine contains "HKLM"
| where AccountName != "system"
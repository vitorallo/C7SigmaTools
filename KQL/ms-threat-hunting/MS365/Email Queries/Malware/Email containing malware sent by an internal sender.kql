// Description: In this query, we are looking for emails containing malware attachment sent by an internal sender
// Required Connectors: MicrosoftThreatProtection (Types: EmailEvents)

EmailEvents
| where EmailDirection == "Intra-org" or EmailDirection == "Outbound"
| where ThreatTypes == "Malware" and SenderFromAddress !startswith "postmaster@" and SenderFromAddress !startswith "microsoftexchange"
| join (EmailAttachmentInfo | where isnotempty(ThreatTypes)) on NetworkMessageId